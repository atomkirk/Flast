var Flast=function(){"use strict";function t(t){if(t){if(Array.isArray(t))return 0;var e;if(_&&_(t),"object"==typeof t&&"function"==typeof(e=t[d]))return _&&_(void 0),e.call(t);if(_&&_(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}function e(t){var n=arguments[1];void 0===n&&(n={}),this.width=t.clientWidth,this.height=t.clientHeight,this.maxZoom=n.maxZoom||4,this.zoomSpeed=n.zoomSpeed||1.01,this.getTileUrl=n.getTileUrl||function(t,e,n){return"http://useredline-api.s3.amazonaws.com/development/tiles/168d136e60b14850d7a671e8/tile_"+t+("_"+e)+("x"+n)+".jpg"},this.tools=n.tools||[e.ARROW,e.LINE,e.CIRCLE,e.RECTANGLE],this.annotations=n.annotations||[],this.callbacks=n.callbacks||{},this._canvas=t,this._ctx=t.getContext("2d"),this._dragStart,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._currentAnnotation=null,this._currentShape=null,this._maxScale=2,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this._addEventListeners(),this._configureCanvas(),this.setTileSize(n.tileSize||{width:624,height:416}),this.redraw()}function n(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var n=e.p1,i=e.p2,a=60;t.beginPath(),t.moveTo(n.x,n.y);var o={dx:i.x-n.x,dy:i.y-n.y},r=Math.sqrt(Math.pow(o.dx,2)+Math.pow(o.dy,2)),s=(r-a)/r;t.lineTo(n.x+o.dx*s,n.y+o.dy*s),t.stroke();var h=Math.atan((i.y-n.y)/(i.x-n.x));h+=(i.x>n.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(i.x,i.y),t.rotate(h),t.moveTo(0,0),t.lineTo(15,a),t.lineTo(-15,a),t.closePath(),t.restore(),t.fill()},hitTest:function(t,n){return e._onLine(t,n)}}}function i(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var n=e.p1,i=e.p2;t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(i.x,i.y),t.stroke()},hitTest:function(t,n){return e._onLine(t,n)}}}function a(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:t,radius:0}},updateGeometry:function(t,e){var n=t.center;return t.radius=Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2)),t},drawInContext:function(t,e){var n=e;t.beginPath(),t.arc(n.center.x,n.center.y,n.radius,0,2*Math.PI),t.stroke()},hitTest:function(t,e){var n=Math.sqrt(Math.pow(e.x-t.center.x,2)+Math.pow(e.y-t.center.y,2));return Math.abs(n-t.radius)<10}}}function o(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var n=e.p1,i=e.p2;t.beginPath(),t.strokeRect(n.x,n.y,i.x-n.x,i.y-n.y),t.stroke()},hitTest:function(e,n){var i,a,o,r=[Math.abs(e.p1.x-n.x),Math.abs(e.p2.x-n.x),Math.abs(e.p1.y-n.y),Math.abs(e.p2.y-n.y)];i=t(r),o=0===i,a=o?r.length:void 0;for(var s;o?i<a:!(a=i.next()).done;)if(s=o?r[i++]:a.value,s<10)return!0;i=a=o=void 0}}}var r=(function(t,e){return t.__proto__={a:e},t.a===e}({},{}),Object.defineProperty),s=Object.getOwnPropertyDescriptor,h=function(t,e){for(var n in e)e.hasOwnProperty(n)&&r(t,n,s(e,n));return t},c=Object.defineProperties,l={},u={},d="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",_="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;return r(e,"prototype",{configurable:!1,enumerable:!1,writable:!1}),u.setTool=function(t){var e=this.tools.find(function(e){return e.name===t});e?(this._state.tool=t,this.redraw()):console.error("Flask: That tool is not defined.")},u.setTileSize=function(t){this.tileSize=t,this._tileCache={},this._contentSize={width:this.tileSize.width*Math.pow(2,this.maxZoom),height:this.tileSize.height*Math.pow(2,this.maxZoom)};var e=this.width/this._contentSize.width,n=this.height/this._contentSize.height;this._minScale=Math.max(e,n)},u.redraw=function(){var e,n,i,a,o,r,s,h=this,c=this._transformedPoint(0,0),l=this._transformedPoint(this.width,this.height),u={x:c.x,y:c.y,width:l.x-c.x,height:l.y-c.y};this._ctx.clearRect(u.x,u.y,u.width,u.height);for(var d=Math.log(this._minScale)/Math.LN2,_=Math.log(this._maxScale)/Math.LN2,f=Math.log(this._transform.a)/Math.LN2,m=(f-d)/(_-d),p=Math.max(Math.ceil(m*this.maxZoom),1),g=Math.pow(2,p),v=this._contentSize.width/g,y=this._contentSize.height/g,x=0;x<g;x++)for(var w=0;w<g;w++){var b={x:Math.floor(x*v),y:Math.floor(w*y),width:Math.floor(v),height:Math.floor(y)};if(this._intersectRect(u,b)){var S=this._tileImage(p,x,w);if(S.complete&&0!==S.naturalHeight)this._ctx.drawImage(S,b.x,b.y,b.width,b.height);else for(var M=p-1;M>0;){var k=Math.floor(x/Math.pow(2,p)*Math.pow(2,M)),T=Math.floor(w/Math.pow(2,p)*Math.pow(2,M)),A=this._tileImage(M,k,T);if(A.complete&&0!==A.naturalHeight){var C=Math.pow(2,p)/Math.pow(2,M),L=x-C*k,P=w-C*T,E=A.width/C,z=A.height/C,I=Math.floor(L*E),G=Math.floor(P*z);this._ctx.drawImage(A,I,G,E,z,b.x,b.y,b.width,b.height);break}M-=1}}}var D=this._currentAnnotation||{shapes:[]};a=this.annotations.concat(D),e=t(a),i=0===e,n=i?a.length:void 0;for(var R;i?e<n:!(n=e.next()).done;){R=i?a[e++]:n.value,this._currentAnnotation&&R!==this._currentAnnotation?this._ctx.globalAlpha=.2:this._ctx.globalAlpha=1;var U=R.shapes;R===D&&(U=U.concat(this._currentShape||[])),o=t(U),s=0===o,r=s?U.length:void 0;for(var O;s?o<r:!(r=o.next()).done;)O=s?U[o++]:r.value,function(t){var e=h.tools.find(function(e){return e.name===t.kind});h._ctx.fillStyle="#FF0000",h._ctx.strokeStyle="#FF0000",h._ctx.lineWidth=10,e.drawInContext(h._ctx,t.geometry)}(O);o=r=s=void 0}e=n=i=a=void 0,this._ctx.globalAlpha=1},u.completeAnnotation=function(){this._currentAnnotation&&(this.annotations.indexOf(this._currentAnnotation)<0&&this.annotations.push(this._currentAnnotation),this.callbacks.annotationCompleted&&this.callbacks.annotationCompleted(this._currentAnnotation)),this._currentAnnotation=null,this._state.tool="none",this.redraw()},u._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseleave",this._mouseLeave.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},u._configureCanvas=function(){this._canvas.setAttribute("width",this.width),this._canvas.setAttribute("height",this.height)},u._updateZoom=function(t){var n=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(n){var i=this._eventPoint(t);this._currentShape&&(this._currentShape.geometry.p2=i);var a=Math.pow(this.zoomSpeed,n),o=e.clamp(this._transform.a*a,this._minScale,this._maxScale);this._transform=this._transform.translate(i.x,i.y),this._transform.a=this._transform.d=o,this._transform=this._transform.translate(-i.x,-i.y),this._clampToBounds(),this._updateTransform()}return t.preventDefault()&&!1},u._mouseDown=function(t){this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},u._mouseUp=function(e){var n,i,a,o,r,s,h,c,l=this;if(this._state.mouse="up",this._state.dragging)this._state.dragging=!1;else if(this._state.drawing||"none"===this._state.tool){if(this._state.drawing)this._state.drawing=!1,this._currentAnnotation||(this._currentAnnotation={shapes:[]},this.callbacks.editingAnnotation&&this.callbacks.editingAnnotation(this._currentAnnotation)),this._currentAnnotation.shapes.push(this._currentShape),this.callbacks.finishedDrawingShape&&this.callbacks.finishedDrawingShape(this._currentShape),this._currentShape=null,this.redraw();else if(!this._currentAnnotation){var u=this._eventPoint(e);o=this.annotations,n=t(o),a=0===n,i=a?o.length:void 0;for(var d;a?n<i:!(i=n.next()).done;){d=a?o[n++]:i.value,c=d.shapes,r=t(c),h=0===r,s=h?c.length:void 0;for(var _;h?r<s:!(s=r.next()).done;){_=h?c[r++]:s.value;var f;if(function(t){var e=l.tools.find(function(e){return e.name===t.kind});if(e.hitTest(t.geometry,u)&&l.callbacks.annotationSelected)return l.callbacks.annotationSelected(d),l._currentAnnotation=d,l.callbacks.editingAnnotation&&l.callbacks.editingAnnotation(d),l.redraw(),void(f=!0)}(_),f===!0)return void(f=void 0)}r=s=h=c=void 0}n=i=a=o=void 0}}else{this._state.drawing=!0;var m=this._eventPoint(e),p=this._currentTool();this._currentShape={kind:p.name,geometry:p.startGeometry(m)},this.callbacks.beganDrawingShape&&this.callbacks.beganDrawingShape(this._currentShape)}},u._mouseMove=function(t){var e=this._eventPoint(t);if("down"!==this._state.mouse||this._state.dragging||(this._state.dragging=!0),this._state.dragging){var n=e.x-this._dragStart.x,i=e.y-this._dragStart.y;this._transform=this._transform.translate(n,i),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,e),this.redraw()}},u._mouseLeave=function(t){this._state.dragging&&(this._state.dragging=!1,this._state.mouse="up")},u._keyUp=function(e){var n,i,a,o;if(this._state.drawing&&27===e.which)this.callbacks.cancelledDrawingShape&&this.callbacks.cancelledDrawingShape(this._currentShape),this._state.drawing=!1,this._currentShape=null,this.redraw();else{o=this.tools,n=t(o),a=0===n,i=a?o.length:void 0;for(var r;a?n<i:!(i=n.next()).done;)r=a?o[n++]:i.value,e.which===r.keyCode&&(this._state.tool=r.name);n=i=a=o=void 0}},u._transformedPoint=function(t,e){var n=this._svg.createSVGPoint();return n.x=t,n.y=e,n.matrixTransform(this._transform.inverse())},u._updateTransform=function(){var t=this._transform;this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f),this.redraw(),this.callbacks.transformWasUpdated&&this.callbacks.transformWasUpdated(t)},u._clampToBounds=function(){var t=this._contentSize.width*this._transform.a,n=this._contentSize.height*this._transform.d;this._transform.e=e.clamp(this._transform.e,-(t-this.width),0),this._transform.f=e.clamp(this._transform.f,-(n-this.height),0)},l.clamp=function(t,e,n){return Math.max(Math.min(t,n),e)},u._eventPoint=function(t){var e=t.offsetX||t.pageX-this._canvas.offsetLeft,n=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(e,n)},u._tileImage=function(t,e,n){var i=this,a=this.getTileUrl(t,e,n),o=this._tileCache[a];return o||(o=new Image,o.src=a,o.onload=function(){i.redraw()},this._tileCache[a]=o),o},u._intersectRect=function(t,e){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},e={left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},u._currentTool=function(){var t=this;return this.tools.find(function(e){return e.name===t._state.tool})},c(e,{ARROW:{get:n,configurable:!0,enumerable:!0},LINE:{get:i,configurable:!0,enumerable:!0},CIRCLE:{get:a,configurable:!0,enumerable:!0},RECTANGLE:{get:o,configurable:!0,enumerable:!0}}),l._onLine=function(t,e){var n=e.x-t.p1.x,i=e.y-t.p1.y,a=t.p2.x-t.p1.x,o=t.p2.y-t.p1.y,r=n*o-i*a;return Math.abs(r)<2e4&&e.x<Math.max(t.p1.x,t.p2.x)+10&&e.x>Math.min(t.p1.x,t.p2.x)-10&&e.y<Math.max(t.p1.y,t.p2.y)+10&&e.y>Math.min(t.p1.y,t.p2.y)-10},h(e,l),h(e.prototype,u),l=u=void 0,e}();