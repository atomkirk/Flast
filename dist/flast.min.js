var Flast=function(){"use strict";function t(t){if(t){if(Array.isArray(t))return 0;var e;if(l&&l(t),"object"==typeof t&&"function"==typeof(e=t[_]))return l&&l(void 0),e.call(t);if(l&&l(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}function e(t){var i=arguments[1];void 0===i&&(i={}),this.width=t.clientWidth,this.height=t.clientHeight,this.maxZoom=i.maxZoom||4,this.zoomSpeed=i.zoomSpeed||1.01,this.getTileUrl=i.getTileUrl||function(t,e,i){return"http://useredline-api.s3.amazonaws.com/development/tiles/168d136e60b14850d7a671e8/tile_"+t+("_"+e)+("x"+i)+".jpg"},this.tools=i.tools||[e.ARROW,e.LINE,e.CIRCLE,e.RECTANGLE],this.annotations=i.annotations||[],this._canvas=t,this._ctx=t.getContext("2d"),this._dragStart,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._currentAnnotation=[],this._currentShape,this._maxScale=2,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this._addEventListeners(),this._configureCanvas(),this.setTileSize(i.tileSize||{width:624,height:416}),this.redraw()}function i(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.moveTo(i.x,i.y);var r={dx:n.x-i.x,dy:n.y-i.y},o=Math.sqrt(Math.pow(r.dx,2)+Math.pow(r.dy,2)),a=(o-20)/o;t.lineTo(i.x+r.dx*a,i.y+r.dy*a),t.stroke();var s=Math.atan((n.y-i.y)/(n.x-i.x));s+=(n.x>i.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(n.x,n.y),t.rotate(s),t.moveTo(0,0),t.lineTo(15,60),t.lineTo(-15,60),t.closePath(),t.restore(),t.fill()}}}function n(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(n.x,n.y),t.stroke()}}}function r(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:t,radius:0}},updateGeometry:function(t,e){var i=t.center;return t.radius=Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2)),t},drawInContext:function(t,e){var i=e;t.beginPath(),t.arc(i.center.x,i.center.y,i.radius,0,2*Math.PI),t.stroke()}}}function o(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.strokeRect(i.x,i.y,n.x-i.x,n.y-i.y),t.stroke()}}}var a=(function(t,e){return t.__proto__={a:e},t.a===e}({},{}),Object.defineProperty),s=Object.getOwnPropertyDescriptor,h=function(t,e){for(var i in e)e.hasOwnProperty(i)&&a(t,i,s(e,i));return t},c=Object.defineProperties,u={},d={},_="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",l="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;return a(e,"prototype",{configurable:!1,enumerable:!1,writable:!1}),d.setTool=function(t){var e=this.tools.find(function(e){return e.name===t});e?this._state.tool=t:console.error("Flask: That tool is not defined.")},d.setTileSize=function(t){this.tileSize=t,this._tileCache={},this._contentSize={width:this.tileSize.width*Math.pow(2,this.maxZoom),height:this.tileSize.height*Math.pow(2,this.maxZoom)};var e=this.width/this._contentSize.width,i=this.height/this._contentSize.height;this._minScale=Math.max(e,i)},d.redraw=function(){var e,i,n,r,o,a,s,h=this,c=this._transformedPoint(0,0),u=this._transformedPoint(this.width,this.height),d={x:c.x,y:c.y,width:u.x-c.x,height:u.y-c.y};this._ctx.clearRect(d.x,d.y,d.width,d.height);for(var _=Math.log(this._minScale)/Math.LN2,l=Math.log(this._maxScale)/Math.LN2,m=Math.log(this._transform.a)/Math.LN2,f=(m-_)/(l-_),g=Math.max(Math.ceil(f*this.maxZoom),1),v=Math.pow(2,g),p=this._contentSize.width/v,y=this._contentSize.height/v,w=0;w<v;w++)for(var x=0;x<v;x++){var S={x:Math.floor(w*p),y:Math.floor(x*y),width:Math.floor(p),height:Math.floor(y)};if(this._intersectRect(d,S)){var b=this._tileImage(g,w,x);b.complete&&0!==b.naturalHeight&&this._ctx.drawImage(b,S.x,S.y,S.width,S.height)}}this._ctx.fillStyle="#FF0000",this._ctx.strokeStyle="#FF0000",this._ctx.lineWidth=10,r=this.annotations.concat(this._currentAnnotation),e=t(r),n=0===e,i=n?r.length:void 0;for(var M;n?e<i:!(i=e.next()).done;){M=n?r[e++]:i.value;var T=M.shapes;M===this._currentAnnotation&&(T=T.concat(this._currentShape||[])),o=t(T),s=0===o,a=s?T.length:void 0;for(var C;s?o<a:!(a=o.next()).done;){C=s?T[o++]:a.value;var P;!function(t){P=h.tools.find(function(e){return e.name===t.kind}),P.drawInContext(h._ctx,t.geometry)}(C)}o=a=s=void 0}e=i=n=r=void 0},d._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseleave",this._mouseLeave.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},d._configureCanvas=function(){this._canvas.setAttribute("width",this.width),this._canvas.setAttribute("height",this.height)},d._updateZoom=function(t){var i=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(i){var n=this._eventPoint(t);this._currentShape&&(this._currentShape.geometry.p2=n);var r=Math.pow(this.zoomSpeed,i),o=e.clamp(this._transform.a*r,this._minScale,this._maxScale);this._transform=this._transform.translate(n.x,n.y),this._transform.a=this._transform.d=o,this._transform=this._transform.translate(-n.x,-n.y),this._clampToBounds(),this._updateTransform()}return t.preventDefault()&&!1},d._mouseDown=function(t){this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},d._mouseUp=function(t){if(this._state.mouse="up",this._state.dragging)this._state.dragging=!1;else if(this._state.drawing||"none"===this._state.tool)this._state.drawing&&(this._state.drawing=!1,this._currentAnnotation.push(this._currentShape),this._currentShape=null);else{this._state.drawing=!0;var e=this._eventPoint(t),i=this._currentTool();this._currentShape={kind:i.name,geometry:i.startGeometry(e)}}},d._mouseMove=function(t){var e=this._eventPoint(t);if("down"!==this._state.mouse||this._state.dragging||(this._state.dragging=!0),this._state.dragging){var i=e.x-this._dragStart.x,n=e.y-this._dragStart.y;this._transform=this._transform.translate(i,n),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var r=this._currentTool();this._currentShape.geometry=r.updateGeometry(this._currentShape.geometry,e),this.redraw()}},d._mouseLeave=function(t){console.log("here"),this._state.dragging&&(this._state.dragging=!1)},d._keyUp=function(e){var i,n,r,o;if(this._state.drawing&&27===e.which)this._state.drawing=!1,this._currentShape=null,this.redraw();else{o=this.tools,i=t(o),r=0===i,n=r?o.length:void 0;for(var a;r?i<n:!(n=i.next()).done;)a=r?o[i++]:n.value,e.which===a.keyCode&&(this._state.tool=a.name);i=n=r=o=void 0}},d._transformedPoint=function(t,e){var i=this._svg.createSVGPoint();return i.x=t,i.y=e,i.matrixTransform(this._transform.inverse())},d._updateTransform=function(){var t=this._transform;this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f),this.redraw()},d._clampToBounds=function(){var t=this._contentSize.width*this._transform.a,i=this._contentSize.height*this._transform.d;this._transform.e=e.clamp(this._transform.e,-(t-this.width),0),this._transform.f=e.clamp(this._transform.f,-(i-this.height),0)},u.clamp=function(t,e,i){return Math.max(Math.min(t,i),e)},d._eventPoint=function(t){var e=t.offsetX||t.pageX-this._canvas.offsetLeft,i=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(e,i)},d._tileImage=function(t,e,i){var n=this,r=this.getTileUrl(t,e,i),o=this._tileCache[r];return o||(o=new Image,o.src=r,o.onload=function(){n.redraw()},this._tileCache[r]=o),o},d._intersectRect=function(t,e){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},e={left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},d._currentTool=function(){var t=this;return this.tools.find(function(e){return e.name===t._state.tool})},c(e,{ARROW:{get:i,configurable:!0,enumerable:!0},LINE:{get:n,configurable:!0,enumerable:!0},CIRCLE:{get:r,configurable:!0,enumerable:!0},RECTANGLE:{get:o,configurable:!0,enumerable:!0}}),h(e,u),h(e.prototype,d),u=d=void 0,e}();