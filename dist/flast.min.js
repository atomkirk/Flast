var _hitMargin=void 0,_lineWidth=void 0,Flast=function(){"use strict";function t(t){if(t){if(Array.isArray(t))return 0;var e;if(_&&_(t),"object"==typeof t&&"function"==typeof(e=t[u]))return _&&_(void 0),e.call(t);if(_&&_(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}function e(t){var e=arguments[1];void 0===e&&(e={}),this._canvas=t,this._once(t),this._init(e),this.redraw()}function i(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,e){return t.p2={x:e.x,y:e.y},t},boundingRect:function(t){var e=Math.min(t.p1.x,t.p2.x),i=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y);return{x:e,y:n,width:i-e,height:Math.max(t.p1.y,t.p2.y)-n}},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(n.x,n.y),t.stroke()},hitTest:function(t,i){return e._onLine(t,i)},scaleGeometry:function(t,e){return{p1:{x:t.p1.x*e,y:t.p1.y*e},p2:{x:t.p2.x*e,y:t.p2.y*e}}}}}function n(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,e){return t.p2={x:e.x,y:e.y},t},boundingRect:function(t){var e=Math.min(t.p1.x,t.p2.x),i=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y);return{x:e,y:n,width:i-e,height:Math.max(t.p1.y,t.p2.y)-n}},drawInContext:function(t,e){var i=e.p1,n=e.p2,a=6*_lineWidth;t.beginPath(),t.moveTo(i.x,i.y);var o={dx:n.x-i.x,dy:n.y-i.y},s=Math.sqrt(Math.pow(o.dx,2)+Math.pow(o.dy,2)),r=(s-a)/s;t.lineTo(i.x+o.dx*r,i.y+o.dy*r),t.stroke();var h=Math.atan((n.y-i.y)/(n.x-i.x));h+=(i.x<=n.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(n.x,n.y),t.rotate(h),t.moveTo(0,0),t.lineTo(3*_lineWidth,a),t.lineTo(-3*_lineWidth,a),t.closePath(),t.restore(),t.fill()},hitTest:function(t,i){return e._onLine(t,i)},scaleGeometry:function(t,e){return{p1:{x:t.p1.x*e,y:t.p1.y*e},p2:{x:t.p2.x*e,y:t.p2.y*e}}}}}function a(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:{x:t.x,y:t.y},radius:0}},updateGeometry:function(t,i){var n=t.center;return t.radius=e._distance(i,n),t},boundingRect:function(t){var e=t.center.x-t.radius,i=t.center.x+t.radius,n=t.center.y-t.radius;return{x:e,y:n,width:i-e,height:t.center.y+t.radius-n}},drawInContext:function(t,e){var i=e;t.beginPath(),t.arc(i.center.x,i.center.y,i.radius,0,2*Math.PI),t.stroke()},hitTest:function(t,i){var n=e._distance(i,t.center);return Math.abs(n-t.radius)<_hitMargin},scaleGeometry:function(t,e){return{center:{x:t.center.x*e,y:t.center.y*e},radius:t.radius*e}}}}function o(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{x:t.x,y:t.y,width:0,height:0}},updateGeometry:function(t,e){return t.width=e.x-t.x,t.height=e.y-t.y,t},finalGeometry:function(t){return{x:Math.min(t.x,t.x+t.width),y:Math.min(t.y,t.y+t.height),width:Math.abs(t.width),height:Math.abs(t.height)}},boundingRect:function(t){return t},drawInContext:function(t,e){var i=e;t.beginPath(),t.strokeRect(i.x,i.y,i.width,i.height),t.stroke()},hitTest:function(e,i){var n,a,o,s=[Math.abs(e.x-i.x),Math.abs(e.x+e.width-i.x),Math.abs(e.y-i.y),Math.abs(e.y+e.height-i.y)];n=t(s),o=0===n,a=o?s.length:void 0;for(;o?n<a:!(a=n.next()).done;)if((o?s[n++]:a.value)<_hitMargin)return!0;n=a=o=void 0},scaleGeometry:function(t,e){return{x:t.x*e,y:t.y*e,width:t.width*e,height:t.height*e}}}}var s=(function(t,e){t.__proto__={a:e},t.a}({},{}),Object.defineProperty),r=Object.getOwnPropertyDescriptor,h=function(t,e){for(var i in e)e.hasOwnProperty(i)&&s(t,i,r(e,i));return t},c=Object.defineProperties,l={},d={},u="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",_="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;return s(e,"prototype",{configurable:!1,enumerable:!1,writable:!1}),d.reinit=function(t){var e=Object.assign(this.originalOptions,t);this._init(e),this.redraw()},d._init=function(t){this.originalOptions=t,this.maxZoom=t.maxZoom||4,this.zoomSpeed=t.zoomSpeed||1.01,this.getTileUrl=t.getTileUrl||function(t,e,i){return"https://s3-us-west-2.amazonaws.com/useredline-api/development/tiles/168d136e60b14850d7a671e8/tile_"+t+"_"+e+"x"+i+".jpg"},this.tools=t.tools||[e.ARROW,e.LINE,e.CIRCLE,e.RECTANGLE],this.annotations=t.annotations||[],this.callbacks=t.callbacks||{},this._currentAnnotation=null,this._currentShape=null,this._maxScale=t.maxScale||2,this._authorColor=t.authorColor,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1,enabled:!0},this._contentSize={width:t.width||624*Math.pow(2,this.maxZoom),height:t.height||416*Math.pow(2,this.maxZoom)},this.setTileSize({width:this._contentSize.width/Math.pow(2,this.maxZoom),height:this._contentSize.height/Math.pow(2,this.maxZoom)}),this._transform.e=this._transform.f=0,this._transform.a=this._transform.d=this._minScale,this._clampToBounds(),this._applyTransform(this._transform)},d._once=function(t){var e=this;this.canvasWidth=t.clientWidth,this.canvasHeight=t.clientHeight;var i=t.getContext("2d");this._ctx=i,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._addEventListeners(),this._configureCanvas(),window.onresize=function(i){var n=e._transform;e.canvasWidth=t.clientWidth,e.canvasHeight=t.clientHeight,e._transform.e=e._transform.f=0,e._transform.a=e._transform.d=e._minScale,e.setTileSize(e.tileSize),e._configureCanvas(),e._clampToBounds(),e._applyTransform(n),e.redraw()}},d._pixelRatio=function(){return window.devicePixelRatio},d.setTool=function(t){this.tools.find(function(e){return e.name===t})?(this._state.tool=t,this.callbacks.didSelectTool&&this.callbacks.didSelectTool(this._state.tool),this.redraw()):console.error("Flask: That tool is not defined.")},d.setEnabled=function(t){this._state.enabled=t},d.setTileSize=function(t){this.tileSize=t,this._tileCache={};var e=this.canvasWidth/this._contentSize.width,i=this.canvasHeight/this._contentSize.height;this._minScale=Math.min(e,i)},d.redraw=function(){var e,i,n,a,o,s,r,h=this,c=this._transformedPoint(0,0),l=this._transformedPoint(this.canvasWidth,this.canvasHeight),d={x:c.x,y:c.y,width:l.x-c.x,height:l.y-c.y};this._ctx.clearRect(d.x,d.y,d.width,d.height),this._ctx.fillStyle="#cccccc",this._ctx.fillRect(-1e9,-1e9,2e9,2e9);for(var u=Math.log(this._minScale)/Math.LN2,_=Math.log(this._maxScale)/Math.LN2,f=Math.log(this._transform.a)/Math.LN2,m=(f-u)/(_-u),p=Math.max(Math.ceil(m*this.maxZoom),1),g=Math.pow(2,p),v=this._contentSize.width/g*this._pixelRatio(),x=this._contentSize.height/g*this._pixelRatio(),y=0;y<g;y++)for(var w=0;w<g;w++){var b={x:y*v,y:w*x,width:v,height:x};if(this._intersectRect(d,b)){var S=this._tileImage(p,y,w);if(S.complete&&0!==S.naturalHeight)this._ctx.drawImage(S,b.x,b.y,b.width,b.height);else for(var M=p-1;M>0;){var T=Math.floor(y/Math.pow(2,p)*Math.pow(2,M)),k=Math.floor(w/Math.pow(2,p)*Math.pow(2,M)),A=this._tileImage(M,T,k);if(A.complete&&0!==A.naturalHeight){var R=Math.pow(2,p)/Math.pow(2,M),C=y-R*T,P=w-R*k,G=A.width/R,L=A.height/R,E=Math.floor(C*G),z=Math.floor(P*L);this._ctx.drawImage(A,E,z,G,L,b.x,b.y,b.width,b.height);break}M-=1}}}var W=this._currentAnnotation||{shapes:[]};a=this.annotations.concat(W),e=t(a),n=0===e,i=n?a.length:void 0;for(var I;n?e<i:!(i=e.next()).done;){I=n?a[e++]:i.value,this._currentAnnotation&&I!==this._currentAnnotation?this._ctx.globalAlpha=.2:this._ctx.globalAlpha=1;var D=I.shapes;I===W&&(D=D.concat(this._currentShape||[])),o=t(D),r=0===o,s=r?D.length:void 0;for(var O;r?o<s:!(s=o.next()).done;)O=r?D[o++]:s.value,function(t){var e=h.tools.find(function(e){return e.name===t.kind});h._ctx.fillStyle=I.color||h._authorColor||"#FF0000",h._ctx.strokeStyle=I.color||h._authorColor||"#FF0000",h._ctx.lineWidth=_lineWidth,e.drawInContext(h._ctx,e.scaleGeometry(t.geometry,h._pixelRatio()))}(O);o=s=r=void 0}e=i=n=a=void 0,this._ctx.globalAlpha=1},d.setAnnotations=function(t){this.annotations=t,this.redraw()},d.completeAnnotation=function(){this._currentAnnotation&&this.callbacks.didFinishAnnotation&&this.callbacks.didFinishAnnotation(this._currentAnnotation),this._state.tool="none",this.callbacks.didSelectTool&&this.callbacks.didSelectTool(null),this.redraw()},d.cancelAnnotation=function(){this._currentAnnotation&&this.callbacks.didCancelAnnotation&&this.callbacks.didCancelAnnotation(this._currentAnnotation),this._currentAnnotation=null,this._state.tool="none",this.callbacks.didSelectTool&&this.callbacks.didSelectTool(null),this.redraw()},d.cancelShape=function(){this._currentShape&&this.callbacks.didCancelDrawingShape&&this.callbacks.didCancelDrawingShape(this._currentShape),this._state.drawing=!1,this._currentShape=null,this.redraw()},d.selectAnnotation=function(t){this._currentAnnotation=t,this.callbacks.didSelectAnnotation&&this.callbacks.didSelectAnnotation(t),this.redraw()},d.boundingRectFor=function(e){var i,n,a,o,s=this,r=1/0,h=0,c=1/0,l=0;o=e.shapes,i=t(o),a=0===i,n=a?o.length:void 0;for(var d;a?i<n:!(n=i.next()).done;)d=a?o[i++]:n.value,function(t){var e=s.tools.find(function(e){return e.name===t.kind}),i=e.boundingRect(e.scaleGeometry(t.geometry,s._pixelRatio()));r=Math.min(r,i.x),h=Math.max(h,i.x+i.width),c=Math.min(c,i.y),l=Math.max(l,i.y+i.height)}(d);return i=n=a=o=void 0,{x:r,y:c,width:h-r,height:l-c}},d.zoomToRect=function(t){var i=this.canvasWidth*this._pixelRatio(),n=this.canvasHeight*this._pixelRatio(),a=i/t.width,o=n/t.height,s=Math.min(a,o);s=e.clamp(s,this._minScale,this._maxScale),this._transform.a=this._transform.d=s,this._transform.e=-t.x*s,this._transform.f=-t.y*s,this._clampToBounds(),this._updateTransform()},d.setTransform=function(t){this._transform=t,this._clampToBounds(),this._updateTransform()},d._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseleave",this._mouseLeave.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},d._configureCanvas=function(){var t=this._pixelRatio();this._canvas.style.width=this.canvasWidth+"px",this._canvas.style.height=this.canvasHeight+"px",this._canvas.setAttribute("width",this.canvasWidth*t),this._canvas.setAttribute("height",this.canvasHeight*t),this._ctx.scale(t,t),_hitMargin=60*this._pixelRatio()*2,_lineWidth=20*this._pixelRatio()*2},d._updateZoom=function(t){var i=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(i){var n=this._eventPoint(t);if(this._currentShape){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,{x:n.x/this._pixelRatio(),y:n.y/this._pixelRatio()})}var o=Math.pow(this.zoomSpeed,i),s=e.clamp(this._transform.a*o,this._minScale,this._maxScale);this._transform=this._transform.translate(n.x,n.y),this._transform.a=this._transform.d=s,this._transform=this._transform.translate(-n.x,-n.y),this._clampToBounds(),this._updateTransform()}return t.preventDefault()&&!1},d._mouseDown=function(t){console.log("mouse down"),this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},d._mouseUp=function(e){var i,n,a,o,s,r,h,c,l=this;if(console.log("mouse up"),console.log(this._state),this._state.mouse="up",this._state.dragging)console.log("stop dragging"),this._state.dragging=!1;else if(!this._state.drawing&&"none"!==this._state.tool&&this._state.enabled){console.log("start dragging"),this._state.drawing=!0;var d=this._eventPoint(e),u=this._currentTool(),_={x:d.x/this._pixelRatio(),y:d.y/this._pixelRatio()};this._currentShape={kind:u.name,geometry:u.startGeometry(_)},this.callbacks.didBeginDrawingShape&&this.callbacks.didBeginDrawingShape(this._currentShape)}else if(this._state.drawing){console.log("stop dragging"),this._state.drawing=!1,this._currentAnnotation||(this._currentAnnotation={shapes:[]},this.callbacks.didStartAnnotation&&this.callbacks.didStartAnnotation(this._currentAnnotation));var f=this._currentTool();f.finalGeometry&&(this._currentShape.geometry=f.finalGeometry(this._currentShape.geometry)),this._currentAnnotation.shapes.push(this._currentShape),this.callbacks.didFinishDrawingShape&&this.callbacks.didFinishDrawingShape(this._currentShape),this._currentShape=null,this.redraw()}else if(this._state.enabled){console.log("try select annotation");var m=this._eventPoint(e);o=this.annotations,i=t(o),a=0===i,n=a?o.length:void 0;for(var p;a?i<n:!(n=i.next()).done;){p=a?o[i++]:n.value,c=p.shapes,s=t(c),h=0===s,r=h?c.length:void 0;for(var g;h?s<r:!(r=s.next()).done;){g=h?c[s++]:r.value;var v;if(function(t){var e=l.tools.find(function(e){return e.name===t.kind});if(e.hitTest(e.scaleGeometry(t.geometry,l._pixelRatio()),m))l.selectAnnotation(p),l.callbacks.didSelectAnnotation&&l.callbacks.didSelectAnnotation(p),v=!0}(g),!0===v)return void(v=void 0)}s=r=h=c=void 0}i=n=a=o=void 0}},d._mouseMove=function(i){var n,a,o,s,r,h,c,l,d=this,u=this._eventPoint(i);if("down"===this._state.mouse&&!this._state.dragging){e._distance(u,this._dragStart)>10&&(this._state.dragging=!0)}if(this._state.dragging){var _=u.x-this._dragStart.x,f=u.y-this._dragStart.y;this._transform=this._transform.translate(_,f),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var m=this._currentTool();this._currentShape.geometry=m.updateGeometry(this._currentShape.geometry,{x:u.x/this._pixelRatio(),y:u.y/this._pixelRatio()}),this.redraw()}if("up"===this._state.mouse&&!this._state.drawing&&this._state.enabled){var p=this._eventPoint(i),g=!1;s=this.annotations,n=t(s),o=0===n,a=o?s.length:void 0;for(var v;o?n<a:!(a=n.next()).done;){v=o?s[n++]:a.value,l=v.shapes,r=t(l),c=0===r,h=c?l.length:void 0;for(var x;c?r<h:!(h=r.next()).done;)x=c?l[r++]:h.value,function(t){var e=d.tools.find(function(e){return e.name===t.kind});e.hitTest(e.scaleGeometry(t.geometry,d._pixelRatio()),p)&&(g=!0)}(x);r=h=c=l=void 0}n=a=o=s=void 0,this.callbacks.mouseOverAnnotation&&this.callbacks.mouseOverAnnotation(g)}},d._mouseLeave=function(t){this._state.dragging&&(this._state.dragging=!1,this._state.mouse="up")},d._keyUp=function(e){var i,n,a,o;if(document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName))return!0;if(this._state.drawing&&27===e.which)return this.cancelShape(),e.preventDefault(),e.stopPropagation(),!0;if(13===e.which&&this._currentAnnotation)this.completeAnnotation();else if(this._state.enabled){o=this.tools,i=t(o),a=0===i,n=a?o.length:void 0;for(var s;a?i<n:!(n=i.next()).done;)if(s=a?o[i++]:n.value,e.which===s.keyCode)return this._state.tool=s.name,this.callbacks.didSelectTool&&this.callbacks.didSelectTool(this._state.tool),e.preventDefault(),e.stopPropagation(),!0;i=n=a=o=void 0}return!0},d._transformedPoint=function(t,e){var i=this._svg.createSVGPoint();return i.x=t*this._pixelRatio(),i.y=e*this._pixelRatio(),i.matrixTransform(this._transform.inverse())},d._applyTransform=function(t){this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f)},d._updateTransform=function(){this._applyTransform(this._transform),this.redraw(),this.callbacks.didUpdateTransform&&this.callbacks.didUpdateTransform(this._transform)},d._clampToBounds=function(){var t=this._contentSize.width*this._transform.a*this._pixelRatio(),i=this._contentSize.height*this._transform.d*this._pixelRatio(),n=this.canvasWidth*this._pixelRatio(),a=this.canvasHeight*this._pixelRatio(),o=t,s=i;t/i<n/a?o=n*(i/a):s=a*(t/n);var r=(o-t)/2,h=-o+n+r;this._transform.e=e.clamp(this._transform.e,h,r);var c=(s-i)/2,l=-s+a+c;this._transform.f=e.clamp(this._transform.f,l,c)},l.clamp=function(t,e,i){return Math.max(Math.min(t,i),e)},d._eventPoint=function(t){var e=t.offsetX||t.pageX-this._canvas.offsetLeft,i=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(e,i)},d._tileImage=function(t,e,i){var n=this,a=this.getTileUrl(t,e,i),o=this._tileCache[a];return o||(o=new Image,o.src=a,o.onload=function(){n.redraw()},this._tileCache[a]=o),o},d._intersectRect=function(t,e){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},e={left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},d._currentTool=function(){var t=this;return this.tools.find(function(e){return e.name===t._state.tool})},l._distance=function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},c(e,{LINE:{get:i,configurable:!0,enumerable:!0},ARROW:{get:n,configurable:!0,enumerable:!0},CIRCLE:{get:a,configurable:!0,enumerable:!0},RECTANGLE:{get:o,configurable:!0,enumerable:!0}}),l._onLine=function(t,e){return this._pointDistToLine(e,t)<_hitMargin},l._pointDistToLine=function(t,e){var i=t.x,n=t.y,a=e.p1.x,o=e.p1.y,s=e.p2.x,r=e.p2.y,h=i-a,c=n-o,l=s-a,d=r-o,u=h*l+c*d,_=l*l+d*d,f=-1;0!=_&&(f=u/_);var m,p;f<0?(m=a,p=o):f>1?(m=s,p=r):(m=a+f*l,p=o+f*d);var g=i-m,v=n-p;return Math.sqrt(g*g+v*v)},h(e,l),h(e.prototype,d),l=d=void 0,e}();