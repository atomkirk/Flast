var Flast=function(){"use strict";function t(t){if(t){if(Array.isArray(t))return 0;var e;if(f&&f(t),"object"==typeof t&&"function"==typeof(e=t[l]))return f&&f(void 0),e.call(t);if(f&&f(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}function e(t){var i=arguments[1];void 0===i&&(i={});var n=this;this.width=t.clientWidth,this.height=t.clientHeight,this.maxZoom=i.maxZoom||4,this.zoomSpeed=i.zoomSpeed||1.01,this.getTileUrl=i.getTileUrl||function(t,e,i){return"https://s3-us-west-2.amazonaws.com/useredline-api/development/tiles/168d136e60b14850d7a671e8/tile_"+t+("_"+e)+("x"+i)+".jpg"},this.tools=i.tools||[e.ARROW,e.LINE,e.CIRCLE,e.RECTANGLE],this.annotations=i.annotations||[],this.callbacks=i.callbacks||{},this._canvas=t,this._ctx=t.getContext("2d"),this._dragStart,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._currentAnnotation=null,this._currentShape=null,this._maxScale=2,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this._addEventListeners(),this._configureCanvas(),window.onresize=function(e){n.width=t.clientWidth,n.height=t.clientHeight,n.setTileSize(n.tileSize),n._configureCanvas(),n.redraw()},this._contentSize={width:i.width||624*Math.pow(2,this.maxZoom),height:i.height||416*Math.pow(2,this.maxZoom)},this.setTileSize(i.tileSize||{width:this._contentSize.width/Math.pow(2,this.maxZoom),height:this._contentSize.height/Math.pow(2,this.maxZoom)}),this.redraw()}function i(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,e){return t.p2={x:e.x,y:e.y},t},boundingRect:function(t){var e=Math.min(t.p1.x,t.p2.x),i=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y),a=Math.max(t.p1.y,t.p2.y);return{x:e,y:n,width:i-e,height:a-n}},drawInContext:function(t,e){var i=e.p1,n=e.p2,a=60;t.beginPath(),t.moveTo(i.x,i.y);var r={dx:n.x-i.x,dy:n.y-i.y},o=Math.sqrt(Math.pow(r.dx,2)+Math.pow(r.dy,2)),h=(o-a)/o;t.lineTo(i.x+r.dx*h,i.y+r.dy*h),t.stroke();var s=Math.atan((n.y-i.y)/(n.x-i.x));s+=(n.x>i.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(n.x,n.y),t.rotate(s),t.moveTo(0,0),t.lineTo(15,a),t.lineTo(-15,a),t.closePath(),t.restore(),t.fill()},hitTest:function(t,i){return e._onLine(t,i)}}}function n(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,e){return t.p2={x:e.x,y:e.y},t},boundingRect:function(t){var e=Math.min(t.p1.x,t.p2.x),i=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y),a=Math.max(t.p1.y,t.p2.y);return{x:e,y:n,width:i-e,height:a-n}},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(n.x,n.y),t.stroke()},hitTest:function(t,i){return e._onLine(t,i)}}}function a(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:{x:t.x,y:t.y},radius:0}},updateGeometry:function(t,e){var i=t.center;return t.radius=Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2)),t},boundingRect:function(t){var e=t.center.x-t.radius,i=t.center.x+t.radius,n=t.center.y-t.radius,a=t.center.y+t.radius;return{x:e,y:n,width:i-e,height:a-n}},drawInContext:function(t,e){var i=e;t.beginPath(),t.arc(i.center.x,i.center.y,i.radius,0,2*Math.PI),t.stroke()},hitTest:function(t,e){var i=Math.sqrt(Math.pow(e.x-t.center.x,2)+Math.pow(e.y-t.center.y,2));return Math.abs(i-t.radius)<10}}}function r(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{x:t.x,y:t.y,width:0,height:0}},updateGeometry:function(t,e){return t.width=e.x-t.x,t.height=e.y-t.y,t},finalGeometry:function(t){return{x:Math.min(t.x,t.x+t.width),y:Math.min(t.y,t.y+t.height),width:Math.abs(t.width),height:Math.abs(t.height)}},boundingRect:function(t){return t},drawInContext:function(t,e){var i=e;t.beginPath(),t.strokeRect(i.x,i.y,i.width,i.height),t.stroke()},hitTest:function(e,i){var n,a,r,o=[Math.abs(e.x-i.x),Math.abs(e.x+e.width-i.x),Math.abs(e.y-i.y),Math.abs(e.y+e.height-i.y)];n=t(o),r=0===n,a=r?o.length:void 0;for(var h;r?n<a:!(a=n.next()).done;)if(h=r?o[n++]:a.value,h<10)return!0;n=a=r=void 0}}}var o=(function(t,e){return t.__proto__={a:e},t.a===e}({},{}),Object.defineProperty),h=Object.getOwnPropertyDescriptor,s=function(t,e){for(var i in e)e.hasOwnProperty(i)&&o(t,i,h(e,i));return t},c=Object.defineProperties,d={},u={},l="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",f="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;return o(e,"prototype",{configurable:!1,enumerable:!1,writable:!1}),u.setTool=function(t){var e=this.tools.find(function(e){return e.name===t});e?(this._state.tool=t,this.redraw()):console.error("Flask: That tool is not defined.")},u.setTileSize=function(t){this.tileSize=t,this._tileCache={};var e=this.width/this._contentSize.width,i=this.height/this._contentSize.height;this._minScale=Math.max(e,i)},u.redraw=function(){var e,i,n,a,r,o,h,s=this,c=this._transformedPoint(0,0),d=this._transformedPoint(this.width,this.height),u={x:c.x,y:c.y,width:d.x-c.x,height:d.y-c.y};this._ctx.clearRect(u.x,u.y,u.width,u.height);for(var l=Math.log(this._minScale)/Math.LN2,f=Math.log(this._maxScale)/Math.LN2,m=Math.log(this._transform.a)/Math.LN2,_=(m-l)/(f-l),g=Math.max(Math.ceil(_*this.maxZoom),1),p=Math.pow(2,g),y=this._contentSize.width/p,x=this._contentSize.height/p,v=0;v<p;v++)for(var w=0;w<p;w++){var b={x:Math.floor(v*y),y:Math.floor(w*x),width:Math.floor(y),height:Math.floor(x)};if(this._intersectRect(u,b)){var M=this._tileImage(g,v,w);if(M.complete&&0!==M.naturalHeight)this._ctx.drawImage(M,b.x,b.y,b.width,b.height);else for(var S=g-1;S>0;){var T=Math.floor(v/Math.pow(2,g)*Math.pow(2,S)),k=Math.floor(w/Math.pow(2,g)*Math.pow(2,S)),A=this._tileImage(S,T,k);if(A.complete&&0!==A.naturalHeight){var C=Math.pow(2,g)/Math.pow(2,S),L=v-C*T,P=w-C*k,z=A.width/C,E=A.height/C,G=Math.floor(L*z),R=Math.floor(P*E);this._ctx.drawImage(A,G,R,z,E,b.x,b.y,b.width,b.height);break}S-=1}}}var I=this._currentAnnotation||{shapes:[]};a=this.annotations.concat(I),e=t(a),n=0===e,i=n?a.length:void 0;for(var D;n?e<i:!(i=e.next()).done;){D=n?a[e++]:i.value,this._currentAnnotation&&D!==this._currentAnnotation?this._ctx.globalAlpha=.2:this._ctx.globalAlpha=1;var F=D.shapes;D===I&&(F=F.concat(this._currentShape||[])),r=t(F),h=0===r,o=h?F.length:void 0;for(var U;h?r<o:!(o=r.next()).done;)U=h?F[r++]:o.value,function(t){var e=s.tools.find(function(e){return e.name===t.kind});s._ctx.fillStyle="#FF0000",s._ctx.strokeStyle="#FF0000",s._ctx.lineWidth=10,e.drawInContext(s._ctx,t.geometry)}(U);r=o=h=void 0}e=i=n=a=void 0,this._ctx.globalAlpha=1},u.completeAnnotation=function(){this._currentAnnotation&&(this.annotations.indexOf(this._currentAnnotation)===-1&&this.annotations.push(this._currentAnnotation),this.callbacks.didFinishAnnotation&&this.callbacks.didFinishAnnotation(this._currentAnnotation)),this._currentAnnotation=null,this._state.tool="none",this.redraw()},u.selectAnnotation=function(t){this._currentAnnotation=t,this.callbacks.didSelectAnnotation&&this.callbacks.didSelectAnnotation(t),this.redraw()},u.boundingRectFor=function(e){var i,n,a,r,o=this,h=1/0,s=0,c=1/0,d=0;r=e.shapes,i=t(r),a=0===i,n=a?r.length:void 0;for(var u;a?i<n:!(n=i.next()).done;)u=a?r[i++]:n.value,function(t){var e=o.tools.find(function(e){return e.name===t.kind}),i=e.boundingRect(t.geometry);h=Math.min(h,i.x),s=Math.max(s,i.x+i.width),c=Math.min(c,i.y),d=Math.max(d,i.y+i.height)}(u);return i=n=a=r=void 0,{x:h,y:c,width:s-h,height:d-c}},u.zoomToRect=function(t){var i=this.width/t.width,n=this.height/t.height,a=Math.min(i,n);a=e.clamp(a,this._minScale,this._maxScale),this._transform.a=this._transform.d=a;var r=this.width*(1/a),o=this.height*(1/a);this._transform.e=-t.x*a,this._transform.f=-t.y*a,this._transform.e+=r*a/2-t.width*a/2,this._transform.f+=o*a/2-t.height*a/2,this._updateTransform()},u._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseleave",this._mouseLeave.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},u._configureCanvas=function(){this._canvas.setAttribute("width",this.width),this._canvas.setAttribute("height",this.height)},u._updateZoom=function(t){var i=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(i){var n=this._eventPoint(t);if(this._currentShape){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,n)}var r=Math.pow(this.zoomSpeed,i),o=e.clamp(this._transform.a*r,this._minScale,this._maxScale);this._transform=this._transform.translate(n.x,n.y),this._transform.a=this._transform.d=o,this._transform=this._transform.translate(-n.x,-n.y),this._clampToBounds(),this._updateTransform()}return t.preventDefault()&&!1},u._mouseDown=function(t){this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},u._mouseUp=function(e){var i,n,a,r,o,h,s,c,d=this;if(this._state.mouse="up",this._state.dragging)this._state.dragging=!1;else if(this._state.drawing||"none"===this._state.tool){if(this._state.drawing){this._state.drawing=!1,this._currentAnnotation||(this._currentAnnotation={shapes:[]},this.callbacks.didStartAnnotation&&this.callbacks.didStartAnnotation(this._currentAnnotation));var u=this._currentTool();u.finalGeometry&&(this._currentShape.geometry=u.finalGeometry(this._currentShape.geometry)),this._currentAnnotation.shapes.push(this._currentShape),this.callbacks.didFinishDrawingShape&&this.callbacks.didFinishDrawingShape(this._currentShape),this._currentShape=null,this.redraw()}else if(!this._currentAnnotation){var l=this._eventPoint(e);r=this.annotations,i=t(r),a=0===i,n=a?r.length:void 0;for(var f;a?i<n:!(n=i.next()).done;){f=a?r[i++]:n.value,c=f.shapes,o=t(c),s=0===o,h=s?c.length:void 0;for(var m;s?o<h:!(h=o.next()).done;){m=s?c[o++]:h.value;var _;if(function(t){var e=d.tools.find(function(e){return e.name===t.kind});if(e.hitTest(t.geometry,l))return d.selectAnnotation(f),void(_=!0)}(m),_===!0)return void(_=void 0)}o=h=s=c=void 0}i=n=a=r=void 0}}else{this._state.drawing=!0;var g=this._eventPoint(e),p=this._currentTool();this._currentShape={kind:p.name,geometry:p.startGeometry(g)},this.callbacks.didBeginDrawingShape&&this.callbacks.didBeginDrawingShape(this._currentShape)}},u._mouseMove=function(t){var e=this._eventPoint(t);if("down"!==this._state.mouse||this._state.dragging||(this._state.dragging=!0),this._state.dragging){var i=e.x-this._dragStart.x,n=e.y-this._dragStart.y;this._transform=this._transform.translate(i,n),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,e),this.redraw()}},u._mouseLeave=function(t){this._state.dragging&&(this._state.dragging=!1,this._state.mouse="up")},u._keyUp=function(e){var i,n,a,r;if(this._state.drawing&&27===e.which)this.callbacks.didCancelDrawingShape&&this.callbacks.didCancelDrawingShape(this._currentShape),this._state.drawing=!1,this._currentShape=null,this.redraw();else{r=this.tools,i=t(r),a=0===i,n=a?r.length:void 0;for(var o;a?i<n:!(n=i.next()).done;)o=a?r[i++]:n.value,e.which===o.keyCode&&(this._state.tool=o.name);i=n=a=r=void 0}},u._transformedPoint=function(t,e){var i=this._svg.createSVGPoint();return i.x=t,i.y=e,i.matrixTransform(this._transform.inverse())},u._updateTransform=function(){var t=this._transform;this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f),this.redraw(),this.callbacks.didUpdateTransform&&this.callbacks.didUpdateTransform(t)},u._clampToBounds=function(){var t=this._contentSize.width*this._transform.a,i=this._contentSize.height*this._transform.d;this._transform.e=e.clamp(this._transform.e,-(t-this.width),0),this._transform.f=e.clamp(this._transform.f,-(i-this.height),0)},d.clamp=function(t,e,i){return Math.max(Math.min(t,i),e)},u._eventPoint=function(t){var e=t.offsetX||t.pageX-this._canvas.offsetLeft,i=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(e,i)},u._tileImage=function(t,e,i){var n=this,a=this.getTileUrl(t,e,i),r=this._tileCache[a];return r||(r=new Image,r.src=a,r.onload=function(){n.redraw()},this._tileCache[a]=r),r},u._intersectRect=function(t,e){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},e={left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},u._currentTool=function(){var t=this;return this.tools.find(function(e){return e.name===t._state.tool})},c(e,{ARROW:{get:i,configurable:!0,enumerable:!0},LINE:{get:n,configurable:!0,enumerable:!0},CIRCLE:{get:a,configurable:!0,enumerable:!0},RECTANGLE:{get:r,configurable:!0,enumerable:!0}}),d._onLine=function(t,e){var i=e.x-t.p1.x,n=e.y-t.p1.y,a=t.p2.x-t.p1.x,r=t.p2.y-t.p1.y,o=i*r-n*a;return Math.abs(o)<2e4&&e.x<Math.max(t.p1.x,t.p2.x)+10&&e.x>Math.min(t.p1.x,t.p2.x)-10&&e.y<Math.max(t.p1.y,t.p2.y)+10&&e.y>Math.min(t.p1.y,t.p2.y)-10},s(e,d),s(e.prototype,u),d=u=void 0,e}();