var _hitMargin=void 0,_lineWidth=void 0,Flast=function(){"use strict";function t(t){if(t){if(Array.isArray(t))return 0;var i;if(_&&_(t),"object"==typeof t&&"function"==typeof(i=t[u]))return _&&_(void 0),i.call(t);if(_&&_(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}function i(t){var i=arguments[1];void 0===i&&(i={}),this._canvas=t,this._once(t),this._init(i),this.redraw()}function e(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,i){return t.p2={x:i.x,y:i.y},t},boundingRect:function(t){var i=Math.min(t.p1.x,t.p2.x),e=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y);return{x:i,y:n,width:e-i,height:Math.max(t.p1.y,t.p2.y)-n}},drawInContext:function(t,i){var e=i.p1,n=i.p2;t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(n.x,n.y),t.stroke()},hitTest:function(t,e){return i._onLine(t,e)},scaleGeometry:function(t,i){return{p1:{x:t.p1.x*i,y:t.p1.y*i},p2:{x:t.p2.x*i,y:t.p2.y*i}}}}}function n(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,i){return t.p2={x:i.x,y:i.y},t},boundingRect:function(t){var i=Math.min(t.p1.x,t.p2.x),e=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y);return{x:i,y:n,width:e-i,height:Math.max(t.p1.y,t.p2.y)-n}},drawInContext:function(t,i){var e=i.p1,n=i.p2,a=6*_lineWidth;t.beginPath(),t.moveTo(e.x,e.y);var o={dx:n.x-e.x,dy:n.y-e.y},r=Math.sqrt(Math.pow(o.dx,2)+Math.pow(o.dy,2)),s=(r-a)/r;t.lineTo(e.x+o.dx*s,e.y+o.dy*s),t.stroke();var h=Math.atan((n.y-e.y)/(n.x-e.x));h+=(n.x>e.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(n.x,n.y),t.rotate(h),t.moveTo(0,0),t.lineTo(3*_lineWidth,a),t.lineTo(-3*_lineWidth,a),t.closePath(),t.restore(),t.fill()},hitTest:function(t,e){return i._onLine(t,e)},scaleGeometry:function(t,i){return{p1:{x:t.p1.x*i,y:t.p1.y*i},p2:{x:t.p2.x*i,y:t.p2.y*i}}}}}function a(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:{x:t.x,y:t.y},radius:0}},updateGeometry:function(t,e){var n=t.center;return t.radius=i._distance(e,n),t},boundingRect:function(t){var i=t.center.x-t.radius,e=t.center.x+t.radius,n=t.center.y-t.radius;return{x:i,y:n,width:e-i,height:t.center.y+t.radius-n}},drawInContext:function(t,i){var e=i;t.beginPath(),t.arc(e.center.x,e.center.y,e.radius,0,2*Math.PI),t.stroke()},hitTest:function(t,e){var n=i._distance(e,t.center);return Math.abs(n-t.radius)<_hitMargin},scaleGeometry:function(t,i){return{center:{x:t.center.x*i,y:t.center.y*i},radius:t.radius*i}}}}function o(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{x:t.x,y:t.y,width:0,height:0}},updateGeometry:function(t,i){return t.width=i.x-t.x,t.height=i.y-t.y,t},finalGeometry:function(t){return{x:Math.min(t.x,t.x+t.width),y:Math.min(t.y,t.y+t.height),width:Math.abs(t.width),height:Math.abs(t.height)}},boundingRect:function(t){return t},drawInContext:function(t,i){var e=i;t.beginPath(),t.strokeRect(e.x,e.y,e.width,e.height),t.stroke()},hitTest:function(i,e){var n,a,o,r=[Math.abs(i.x-e.x),Math.abs(i.x+i.width-e.x),Math.abs(i.y-e.y),Math.abs(i.y+i.height-e.y)];n=t(r),o=0===n,a=o?r.length:void 0;for(;o?n<a:!(a=n.next()).done;)if((o?r[n++]:a.value)<_hitMargin)return!0;n=a=o=void 0},scaleGeometry:function(t,i){return{x:t.x*i,y:t.y*i,width:t.width*i,height:t.height*i}}}}var r=(function(t,i){t.__proto__={a:i},t.a}({},{}),Object.defineProperty),s=Object.getOwnPropertyDescriptor,h=function(t,i){for(var e in i)i.hasOwnProperty(e)&&r(t,e,s(i,e));return t},c=Object.defineProperties,l={},d={},u="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",_="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;return r(i,"prototype",{configurable:!1,enumerable:!1,writable:!1}),d.reinit=function(t){this._init(t),this.redraw()},d._init=function(t){this.maxZoom=t.maxZoom||4,this.zoomSpeed=t.zoomSpeed||1.01,this.getTileUrl=t.getTileUrl||function(t,i,e){return"https://s3-us-west-2.amazonaws.com/useredline-api/development/tiles/168d136e60b14850d7a671e8/tile_"+t+"_"+i+"x"+e+".jpg"},this.tools=t.tools||[i.ARROW,i.LINE,i.CIRCLE,i.RECTANGLE],this.annotations=t.annotations||[],this.callbacks=t.callbacks||{},this._currentAnnotation=null,this._currentShape=null,this._maxScale=t.maxScale||2,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this._contentSize={width:t.width||624*Math.pow(2,this.maxZoom),height:t.height||416*Math.pow(2,this.maxZoom)},this.setTileSize({width:this._contentSize.width/Math.pow(2,this.maxZoom),height:this._contentSize.height/Math.pow(2,this.maxZoom)}),this._transform.e=this._transform.f=0,this._transform.a=this._transform.d=this._minScale,this._clampToBounds(),this._applyTransform(this._transform)},d._once=function(t){var i=this;this.canvasWidth=t.clientWidth,this.canvasHeight=t.clientHeight;var e=t.getContext("2d");this._ctx=e,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._addEventListeners(),this._configureCanvas(),window.onresize=function(e){var n=i._transform;i.canvasWidth=t.clientWidth,i.canvasHeight=t.clientHeight,i._transform.e=i._transform.f=0,i._transform.a=i._transform.d=i._minScale,i.setTileSize(i.tileSize),i._configureCanvas(),i._clampToBounds(),i._applyTransform(n),i.redraw()}},d._pixelRatio=function(){return window.devicePixelRatio},d.setTool=function(t){this.tools.find(function(i){return i.name===t})?(this._state.tool=t,this.redraw()):console.error("Flask: That tool is not defined.")},d.setTileSize=function(t){this.tileSize=t,this._tileCache={};var i=this.canvasWidth/this._contentSize.width,e=this.canvasHeight/this._contentSize.height;this._minScale=Math.min(i,e)},d.redraw=function(){var i,e,n,a,o,r,s,h=this,c=this._transformedPoint(0,0),l=this._transformedPoint(this.canvasWidth,this.canvasHeight),d={x:c.x,y:c.y,width:l.x-c.x,height:l.y-c.y};this._ctx.clearRect(d.x,d.y,d.width,d.height),this._ctx.fillStyle="#cccccc",this._ctx.fillRect(-1e9,-1e9,2e9,2e9);for(var u=Math.log(this._minScale)/Math.LN2,_=Math.log(this._maxScale)/Math.LN2,f=Math.log(this._transform.a)/Math.LN2,m=(f-u)/(_-u),p=Math.max(Math.ceil(m*this.maxZoom),1),x=Math.pow(2,p),y=this._contentSize.width/x*this._pixelRatio(),g=this._contentSize.height/x*this._pixelRatio(),v=0;v<x;v++)for(var w=0;w<x;w++){var b={x:v*y,y:w*g,width:y,height:g};if(this._intersectRect(d,b)){var S=this._tileImage(p,v,w);if(S.complete&&0!==S.naturalHeight)this._ctx.drawImage(S,b.x,b.y,b.width,b.height);else for(var M=p-1;M>0;){var T=Math.floor(v/Math.pow(2,p)*Math.pow(2,M)),R=Math.floor(w/Math.pow(2,p)*Math.pow(2,M)),A=this._tileImage(M,T,R);if(A.complete&&0!==A.naturalHeight){var k=Math.pow(2,p)/Math.pow(2,M),C=v-k*T,G=w-k*R,L=A.width/k,P=A.height/k,z=Math.floor(C*L),E=Math.floor(G*P);this._ctx.drawImage(A,z,E,L,P,b.x,b.y,b.width,b.height);break}M-=1}}}var W=this._currentAnnotation||{shapes:[]};a=this.annotations.concat(W),i=t(a),n=0===i,e=n?a.length:void 0;for(var I;n?i<e:!(e=i.next()).done;){I=n?a[i++]:e.value,this._currentAnnotation&&I!==this._currentAnnotation?this._ctx.globalAlpha=.2:this._ctx.globalAlpha=1;var D=I.shapes;I===W&&(D=D.concat(this._currentShape||[])),o=t(D),s=0===o,r=s?D.length:void 0;for(var H;s?o<r:!(r=o.next()).done;)H=s?D[o++]:r.value,function(t){var i=h.tools.find(function(i){return i.name===t.kind});h._ctx.fillStyle=I.color||"#FF0000",h._ctx.strokeStyle=I.color||"#FF0000",h._ctx.lineWidth=_lineWidth,i.drawInContext(h._ctx,i.scaleGeometry(t.geometry,h._pixelRatio()))}(H);o=r=s=void 0}i=e=n=a=void 0,this._ctx.globalAlpha=1},d.setAnnotations=function(t){this.annotations=t,this.redraw()},d.completeAnnotation=function(){this._currentAnnotation&&(-1===this.annotations.indexOf(this._currentAnnotation)&&this.annotations.push(this._currentAnnotation),this.callbacks.didFinishAnnotation&&this.callbacks.didFinishAnnotation(this._currentAnnotation)),this._currentAnnotation=null,this._state.tool="none",this.redraw()},d.cancelAnnotation=function(){this._currentAnnotation&&this.callbacks.didCancelAnnotation&&this.callbacks.didCancelAnnotation(this._currentAnnotation),this._currentAnnotation=null,this._state.tool="none",this.redraw()},d.selectAnnotation=function(t){this._currentAnnotation=t,this.redraw()},d.boundingRectFor=function(i){var e,n,a,o,r=this,s=1/0,h=0,c=1/0,l=0;o=i.shapes,e=t(o),a=0===e,n=a?o.length:void 0;for(var d;a?e<n:!(n=e.next()).done;)d=a?o[e++]:n.value,function(t){var i=r.tools.find(function(i){return i.name===t.kind}),e=i.boundingRect(i.scaleGeometry(t.geometry,r._pixelRatio()));s=Math.min(s,e.x),h=Math.max(h,e.x+e.width),c=Math.min(c,e.y),l=Math.max(l,e.y+e.height)}(d);return e=n=a=o=void 0,{x:s,y:c,width:h-s,height:l-c}},d.zoomToRect=function(t){var e=this.canvasWidth*this._pixelRatio(),n=this.canvasHeight*this._pixelRatio(),a=e/t.width,o=n/t.height,r=Math.min(a,o);r=i.clamp(r,this._minScale,this._maxScale),this._transform.a=this._transform.d=r,this._transform.e=-t.x*r,this._transform.f=-t.y*r,this._updateTransform()},d.setTransform=function(t){this._transform=t,this._clampToBounds(),this._updateTransform()},d._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseleave",this._mouseLeave.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},d._configureCanvas=function(){var t=this._pixelRatio();this._canvas.style.width=this.canvasWidth+"px",this._canvas.style.height=this.canvasHeight+"px",this._canvas.setAttribute("width",this.canvasWidth*t),this._canvas.setAttribute("height",this.canvasHeight*t),this._ctx.scale(t,t),_hitMargin=60*this._pixelRatio()*2,_lineWidth=20*this._pixelRatio()*2},d._updateZoom=function(t){var e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(e){var n=this._eventPoint(t);if(this._currentShape){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,{x:n.x/this._pixelRatio(),y:n.y/this._pixelRatio()})}var o=Math.pow(this.zoomSpeed,e),r=i.clamp(this._transform.a*o,this._minScale,this._maxScale);this._transform=this._transform.translate(n.x,n.y),this._transform.a=this._transform.d=r,this._transform=this._transform.translate(-n.x,-n.y),this._clampToBounds(),this._updateTransform()}return t.preventDefault()&&!1},d._mouseDown=function(t){this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},d._mouseUp=function(i){var e,n,a,o,r,s,h,c,l=this;if(this._state.mouse="up",this._state.dragging)this._state.dragging=!1;else if(this._state.drawing||"none"===this._state.tool){if(this._state.drawing){this._state.drawing=!1,this._currentAnnotation||(this._currentAnnotation={shapes:[]},this.callbacks.didStartAnnotation&&this.callbacks.didStartAnnotation(this._currentAnnotation));var d=this._currentTool();d.finalGeometry&&(this._currentShape.geometry=d.finalGeometry(this._currentShape.geometry)),this._currentAnnotation.shapes.push(this._currentShape),this.callbacks.didFinishDrawingShape&&this.callbacks.didFinishDrawingShape(this._currentShape),this._currentShape=null,this.redraw()}else if(!this._currentAnnotation){var u=this._eventPoint(i);o=this.annotations,e=t(o),a=0===e,n=a?o.length:void 0;for(var _;a?e<n:!(n=e.next()).done;){_=a?o[e++]:n.value,c=_.shapes,r=t(c),h=0===r,s=h?c.length:void 0;for(var f;h?r<s:!(s=r.next()).done;){f=h?c[r++]:s.value;var m;if(function(t){var i=l.tools.find(function(i){return i.name===t.kind});if(i.hitTest(i.scaleGeometry(t.geometry,l._pixelRatio()),u))l.selectAnnotation(_),l.callbacks.didSelectAnnotation&&l.callbacks.didSelectAnnotation(_),m=!0}(f),!0===m)return void(m=void 0)}r=s=h=c=void 0}e=n=a=o=void 0}}else{this._state.drawing=!0;var p=this._eventPoint(i),x=this._currentTool(),y={x:p.x/this._pixelRatio(),y:p.y/this._pixelRatio()};this._currentShape={kind:x.name,geometry:x.startGeometry(y)},this.callbacks.didBeginDrawingShape&&this.callbacks.didBeginDrawingShape(this._currentShape)}},d._mouseMove=function(t){var e=this._eventPoint(t);if("down"===this._state.mouse&&!this._state.dragging){i._distance(e,this._dragStart)>5&&(this._state.dragging=!0)}if(this._state.dragging){var n=e.x-this._dragStart.x,a=e.y-this._dragStart.y;this._transform=this._transform.translate(n,a),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var o=this._currentTool();this._currentShape.geometry=o.updateGeometry(this._currentShape.geometry,{x:e.x/this._pixelRatio(),y:e.y/this._pixelRatio()}),this.redraw()}},d._mouseLeave=function(t){this._state.dragging&&(this._state.dragging=!1,this._state.mouse="up")},d._keyUp=function(i){var e,n,a,o;if(this._state.drawing&&27===i.which)this.callbacks.didCancelDrawingShape&&this.callbacks.didCancelDrawingShape(this._currentShape),this._state.drawing=!1,this._currentShape=null,this.redraw();else{o=this.tools,e=t(o),a=0===e,n=a?o.length:void 0;for(var r;a?e<n:!(n=e.next()).done;)r=a?o[e++]:n.value,i.which===r.keyCode&&(this._state.tool=r.name);e=n=a=o=void 0}},d._transformedPoint=function(t,i){var e=this._svg.createSVGPoint();return e.x=t*this._pixelRatio(),e.y=i*this._pixelRatio(),e.matrixTransform(this._transform.inverse())},d._applyTransform=function(t){this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f)},d._updateTransform=function(){this._applyTransform(this._transform),this.redraw(),this.callbacks.didUpdateTransform&&this.callbacks.didUpdateTransform(this._transform)},d._clampToBounds=function(){var t=this._contentSize.width*this._transform.a*this._pixelRatio(),e=this._contentSize.height*this._transform.d*this._pixelRatio(),n=this.canvasWidth*this._pixelRatio(),a=this.canvasHeight*this._pixelRatio(),o=t,r=e;t/e<n/a?o=n*(e/a):r=a*(t/n);var s=(o-t)/2,h=-o+n+s;this._transform.e=i.clamp(this._transform.e,h,s);var c=(r-e)/2,l=-r+a+c;this._transform.f=i.clamp(this._transform.f,l,c)},l.clamp=function(t,i,e){return Math.max(Math.min(t,e),i)},d._eventPoint=function(t){var i=t.offsetX||t.pageX-this._canvas.offsetLeft,e=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(i,e)},d._tileImage=function(t,i,e){var n=this,a=this.getTileUrl(t,i,e),o=this._tileCache[a];return o||(o=new Image,o.src=a,o.onload=function(){n.redraw()},this._tileCache[a]=o),o},d._intersectRect=function(t,i){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},i={left:i.x,right:i.x+i.width,top:i.y,bottom:i.y+i.height},!(i.left>t.right||i.right<t.left||i.top>t.bottom||i.bottom<t.top)},d._currentTool=function(){var t=this;return this.tools.find(function(i){return i.name===t._state.tool})},l._distance=function(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))},c(i,{LINE:{get:e,configurable:!0,enumerable:!0},ARROW:{get:n,configurable:!0,enumerable:!0},CIRCLE:{get:a,configurable:!0,enumerable:!0},RECTANGLE:{get:o,configurable:!0,enumerable:!0}}),l._onLine=function(t,i){return this._pointDistToLine(i,t)<_hitMargin},l._pointDistToLine=function(t,i){var e=t.x,n=t.y,a=i.p1.x,o=i.p1.y,r=i.p2.x,s=i.p2.y,h=e-a,c=n-o,l=r-a,d=s-o,u=h*l+c*d,_=l*l+d*d,f=-1;0!=_&&(f=u/_);var m,p;f<0?(m=a,p=o):f>1?(m=r,p=s):(m=a+f*l,p=o+f*d);var x=e-m,y=n-p;return Math.sqrt(x*x+y*y)},h(i,l),h(i.prototype,d),l=d=void 0,i}();