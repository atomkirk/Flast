var _hitMargin=void 0,_lineWidth=void 0,Flast=function(){"use strict";function t(t){if(t){if(Array.isArray(t))return 0;var i;if(_&&_(t),"object"==typeof t&&"function"==typeof(i=t[u]))return _&&_(void 0),i.call(t);if(_&&_(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}function i(t){var i=arguments[1];void 0===i&&(i={}),this._canvas=t,this._once(t),this._init(i),this.redraw()}function e(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,i){return t.p2={x:i.x,y:i.y},t},boundingRect:function(t){var i=Math.min(t.p1.x,t.p2.x),e=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y);return{x:i,y:n,width:e-i,height:Math.max(t.p1.y,t.p2.y)-n}},drawInContext:function(t,i){var e=i.p1,n=i.p2;t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(n.x,n.y),t.stroke()},hitTest:function(t,e){return i._onLine(t,e)},scaleGeometry:function(t,i){return{p1:{x:t.p1.x*i,y:t.p1.y*i},p2:{x:t.p2.x*i,y:t.p2.y*i}}}}}function n(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,i){return t.p2={x:i.x,y:i.y},t},boundingRect:function(t){var i=Math.min(t.p1.x,t.p2.x),e=Math.max(t.p1.x,t.p2.x),n=Math.min(t.p1.y,t.p2.y);return{x:i,y:n,width:e-i,height:Math.max(t.p1.y,t.p2.y)-n}},drawInContext:function(t,i){var e=i.p1,n=i.p2;t.beginPath(),t.moveTo(e.x,e.y);var a={dx:n.x-e.x,dy:n.y-e.y},o=Math.sqrt(Math.pow(a.dx,2)+Math.pow(a.dy,2)),r=(o-60)/o;t.lineTo(e.x+a.dx*r,e.y+a.dy*r),t.stroke();var s=Math.atan((n.y-e.y)/(n.x-e.x));s+=(n.x>e.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(n.x,n.y),t.rotate(s),t.moveTo(0,0),t.lineTo(15,60),t.lineTo(-15,60),t.closePath(),t.restore(),t.fill()},hitTest:function(t,e){return i._onLine(t,e)},scaleGeometry:function(t,i){return{p1:{x:t.p1.x*i,y:t.p1.y*i},p2:{x:t.p2.x*i,y:t.p2.y*i}}}}}function a(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:{x:t.x,y:t.y},radius:0}},updateGeometry:function(t,e){var n=t.center;return t.radius=i._distance(e,n),t},boundingRect:function(t){var i=t.center.x-t.radius,e=t.center.x+t.radius,n=t.center.y-t.radius;return{x:i,y:n,width:e-i,height:t.center.y+t.radius-n}},drawInContext:function(t,i){var e=i;t.beginPath(),t.arc(e.center.x,e.center.y,e.radius,0,2*Math.PI),t.stroke()},hitTest:function(t,e){var n=i._distance(e,t.center);return Math.abs(n-t.radius)<_hitMargin},scaleGeometry:function(t,i){return{center:{x:t.center.x*i,y:t.center.y*i},radius:t.radius*i}}}}function o(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{x:t.x,y:t.y,width:0,height:0}},updateGeometry:function(t,i){return t.width=i.x-t.x,t.height=i.y-t.y,t},finalGeometry:function(t){return{x:Math.min(t.x,t.x+t.width),y:Math.min(t.y,t.y+t.height),width:Math.abs(t.width),height:Math.abs(t.height)}},boundingRect:function(t){return t},drawInContext:function(t,i){var e=i;t.beginPath(),t.strokeRect(e.x,e.y,e.width,e.height),t.stroke()},hitTest:function(i,e){var n,a,o,r=[Math.abs(i.x-e.x),Math.abs(i.x+i.width-e.x),Math.abs(i.y-e.y),Math.abs(i.y+i.height-e.y)];n=t(r),o=0===n,a=o?r.length:void 0;for(;o?n<a:!(a=n.next()).done;)if((o?r[n++]:a.value)<_hitMargin)return!0;n=a=o=void 0},scaleGeometry:function(t,i){return{x:t.x*i,y:t.y*i,width:t.width*i,height:t.height*i}}}}var r=(function(t,i){t.__proto__={a:i},t.a}({},{}),Object.defineProperty),s=Object.getOwnPropertyDescriptor,h=function(t,i){for(var e in i)i.hasOwnProperty(e)&&r(t,e,s(i,e));return t},c=Object.defineProperties,d={},l={},u="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",_="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;return r(i,"prototype",{configurable:!1,enumerable:!1,writable:!1}),l.reinit=function(t){this._init(t),this.redraw()},l._init=function(t){this.maxZoom=t.maxZoom||4,this.zoomSpeed=t.zoomSpeed||1.01,this.getTileUrl=t.getTileUrl||function(t,i,e){return"https://s3-us-west-2.amazonaws.com/useredline-api/development/tiles/168d136e60b14850d7a671e8/tile_"+t+"_"+i+"x"+e+".jpg"},this.tools=t.tools||[i.ARROW,i.LINE,i.CIRCLE,i.RECTANGLE],this.annotations=t.annotations||[],this.callbacks=t.callbacks||{},this._currentAnnotation=null,this._currentShape=null,this._maxScale=t.maxScale||2,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this._contentSize={width:t.width||624*Math.pow(2,this.maxZoom),height:t.height||416*Math.pow(2,this.maxZoom)},this.setTileSize({width:this._contentSize.width/Math.pow(2,this.maxZoom),height:this._contentSize.height/Math.pow(2,this.maxZoom)}),this._transform.e=this._transform.f=0,this._transform.a=this._transform.d=this._minScale,this._applyTransform(this._transform)},l._once=function(t){var i=this;this.width=t.clientWidth,this.height=t.clientHeight;var e=t.getContext("2d");this._ctx=e,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._addEventListeners(),this._configureCanvas(),window.onresize=function(e){var n=i._transform;i.width=t.clientWidth,i.height=t.clientHeight,i.setTileSize(i.tileSize),i._configureCanvas(),i._applyTransform(n),i.redraw()}},l.setTool=function(t){this.tools.find(function(i){return i.name===t})?(this._state.tool=t,this.redraw()):console.error("Flask: That tool is not defined.")},l.setTileSize=function(t){this.tileSize=t,this._tileCache={};var i=this.width/this._contentSize.width,e=this.height/this._contentSize.height;this._minScale=Math.max(i,e)},l.redraw=function(){var i,e,n,a,o,r,s,h=this,c=this._transformedPoint(0,0),d=this._transformedPoint(this.width,this.height),l={x:c.x,y:c.y,width:d.x-c.x,height:d.y-c.y};this._ctx.clearRect(l.x,l.y,l.width,l.height);for(var u=Math.log(this._minScale)/Math.LN2,_=Math.log(this._maxScale)/Math.LN2,m=Math.log(this._transform.a)/Math.LN2,f=(m-u)/(_-u),p=Math.max(Math.ceil(f*this.maxZoom),1),x=Math.pow(2,p),y=this._contentSize.width/x*window.devicePixelRatio,g=this._contentSize.height/x*window.devicePixelRatio,v=0;v<x;v++)for(var w=0;w<x;w++){var b={x:v*y,y:w*g,width:y,height:g};if(this._intersectRect(l,b)){var M=this._tileImage(p,v,w);if(M.complete&&0!==M.naturalHeight)this._ctx.drawImage(M,b.x,b.y,b.width,b.height);else for(var S=p-1;S>0;){var T=Math.floor(v/Math.pow(2,p)*Math.pow(2,S)),A=Math.floor(w/Math.pow(2,p)*Math.pow(2,S)),P=this._tileImage(S,T,A);if(P.complete&&0!==P.naturalHeight){var k=Math.pow(2,p)/Math.pow(2,S),R=v-k*T,C=w-k*A,G=P.width/k,L=P.height/k,z=Math.floor(R*G),E=Math.floor(C*L);this._ctx.drawImage(P,z,E,G,L,b.x,b.y,b.width,b.height);break}S-=1}}}var I=this._currentAnnotation||{shapes:[]};a=this.annotations.concat(I),i=t(a),n=0===i,e=n?a.length:void 0;for(var D;n?i<e:!(e=i.next()).done;){D=n?a[i++]:e.value,this._currentAnnotation&&D!==this._currentAnnotation?this._ctx.globalAlpha=.2:this._ctx.globalAlpha=1;var F=D.shapes;D===I&&(F=F.concat(this._currentShape||[])),o=t(F),s=0===o,r=s?F.length:void 0;for(var U;s?o<r:!(r=o.next()).done;)U=s?F[o++]:r.value,function(t){var i=h.tools.find(function(i){return i.name===t.kind});h._ctx.fillStyle=D.color||"#FF0000",h._ctx.strokeStyle=D.color||"#FF0000",h._ctx.lineWidth=_lineWidth,i.drawInContext(h._ctx,i.scaleGeometry(t.geometry,window.devicePixelRatio))}(U);o=r=s=void 0}i=e=n=a=void 0,this._ctx.globalAlpha=1},l.completeAnnotation=function(){this._currentAnnotation&&(-1===this.annotations.indexOf(this._currentAnnotation)&&this.annotations.push(this._currentAnnotation),this.callbacks.didFinishAnnotation&&this.callbacks.didFinishAnnotation(this._currentAnnotation)),this._currentAnnotation=null,this._state.tool="none",this.redraw()},l.cancelAnnotation=function(){this._currentAnnotation&&this.callbacks.didCancelAnnotation&&this.callbacks.didCancelAnnotation(this._currentAnnotation),this._currentAnnotation=null,this._state.tool="none",this.redraw()},l.selectAnnotation=function(t){this._currentAnnotation=t,this.redraw()},l.boundingRectFor=function(i){var e,n,a,o,r=this,s=1/0,h=0,c=1/0,d=0;o=i.shapes,e=t(o),a=0===e,n=a?o.length:void 0;for(var l;a?e<n:!(n=e.next()).done;)l=a?o[e++]:n.value,function(t){var i=r.tools.find(function(i){return i.name===t.kind}),e=i.boundingRect(i.scaleGeometry(t.geometry,window.devicePixelRatio));s=Math.min(s,e.x),h=Math.max(h,e.x+e.width),c=Math.min(c,e.y),d=Math.max(d,e.y+e.height)}(l);return e=n=a=o=void 0,{x:s,y:c,width:h-s,height:d-c}},l.zoomToRect=function(t){var e=this.width/t.width,n=this.height/t.height,a=Math.min(e,n);a=i.clamp(a,this._minScale,this._maxScale),this._transform.a=this._transform.d=a;var o=this.width*(1/a),r=this.height*(1/a);this._transform.e=-t.x*a,this._transform.f=-t.y*a,this._transform.e+=o*a/2-t.width*a/2,this._transform.f+=r*a/2-t.height*a/2,this._updateTransform()},l.setTransform=function(t){this._transform=t,this._clampToBounds(),this._updateTransform()},l._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseleave",this._mouseLeave.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},l._configureCanvas=function(){var t=window.devicePixelRatio;this._canvas.style.width=this.width+"px",this._canvas.style.height=this.height+"px",this._canvas.setAttribute("width",this.width*t),this._canvas.setAttribute("height",this.height*t),this._ctx.scale(t,t),_hitMargin=10*window.devicePixelRatio,_lineWidth=20*window.devicePixelRatio},l._updateZoom=function(t){var e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(e){var n=this._eventPoint(t);if(this._currentShape){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,{x:n.x/window.devicePixelRatio,y:n.y/window.devicePixelRatio})}var o=Math.pow(this.zoomSpeed,e),r=i.clamp(this._transform.a*o,this._minScale,this._maxScale);this._transform=this._transform.translate(n.x,n.y),this._transform.a=this._transform.d=r,this._transform=this._transform.translate(-n.x,-n.y),this._clampToBounds(),this._updateTransform()}return t.preventDefault()&&!1},l._mouseDown=function(t){this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},l._mouseUp=function(i){var e,n,a,o,r,s,h,c,d=this;if(this._state.mouse="up",this._state.dragging)this._state.dragging=!1;else if(this._state.drawing||"none"===this._state.tool){if(this._state.drawing){this._state.drawing=!1,this._currentAnnotation||(this._currentAnnotation={shapes:[]},this.callbacks.didStartAnnotation&&this.callbacks.didStartAnnotation(this._currentAnnotation));var l=this._currentTool();l.finalGeometry&&(this._currentShape.geometry=l.finalGeometry(this._currentShape.geometry)),this._currentAnnotation.shapes.push(this._currentShape),this.callbacks.didFinishDrawingShape&&this.callbacks.didFinishDrawingShape(this._currentShape),this._currentShape=null,this.redraw()}else if(!this._currentAnnotation){var u=this._eventPoint(i);o=this.annotations,e=t(o),a=0===e,n=a?o.length:void 0;for(var _;a?e<n:!(n=e.next()).done;){_=a?o[e++]:n.value,c=_.shapes,r=t(c),h=0===r,s=h?c.length:void 0;for(var m;h?r<s:!(s=r.next()).done;){m=h?c[r++]:s.value;var f;if(function(t){var i=d.tools.find(function(i){return i.name===t.kind});if(i.hitTest(i.scaleGeometry(t.geometry,window.devicePixelRatio),u))d.selectAnnotation(_),d.callbacks.didSelectAnnotation&&d.callbacks.didSelectAnnotation(_),f=!0}(m),!0===f)return void(f=void 0)}r=s=h=c=void 0}e=n=a=o=void 0}}else{this._state.drawing=!0;var p=this._eventPoint(i),x=this._currentTool(),y={x:p.x/window.devicePixelRatio,y:p.y/window.devicePixelRatio};this._currentShape={kind:x.name,geometry:x.startGeometry(y)},this.callbacks.didBeginDrawingShape&&this.callbacks.didBeginDrawingShape(this._currentShape)}},l._mouseMove=function(t){var e=this._eventPoint(t);if("down"===this._state.mouse&&!this._state.dragging){i._distance(e,this._dragStart)>5&&(this._state.dragging=!0)}if(this._state.dragging){var n=e.x-this._dragStart.x,a=e.y-this._dragStart.y;this._transform=this._transform.translate(n,a),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var o=this._currentTool();this._currentShape.geometry=o.updateGeometry(this._currentShape.geometry,{x:e.x/window.devicePixelRatio,y:e.y/window.devicePixelRatio}),this.redraw()}},l._mouseLeave=function(t){this._state.dragging&&(this._state.dragging=!1,this._state.mouse="up")},l._keyUp=function(i){var e,n,a,o;if(this._state.drawing&&27===i.which)this.callbacks.didCancelDrawingShape&&this.callbacks.didCancelDrawingShape(this._currentShape),this._state.drawing=!1,this._currentShape=null,this.redraw();else{o=this.tools,e=t(o),a=0===e,n=a?o.length:void 0;for(var r;a?e<n:!(n=e.next()).done;)r=a?o[e++]:n.value,i.which===r.keyCode&&(this._state.tool=r.name);e=n=a=o=void 0}},l._transformedPoint=function(t,i){var e=this._svg.createSVGPoint();return e.x=t*window.devicePixelRatio,e.y=i*window.devicePixelRatio,e.matrixTransform(this._transform.inverse())},l._applyTransform=function(t){this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f)},l._updateTransform=function(){this._applyTransform(this._transform),this.redraw(),this.callbacks.didUpdateTransform&&this.callbacks.didUpdateTransform(this._transform)},l._clampToBounds=function(){var t=this._contentSize.width*this._transform.a,e=this._contentSize.height*this._transform.d;this._transform.e=i.clamp(this._transform.e,-(t-this.width)*window.devicePixelRatio,0),this._transform.f=i.clamp(this._transform.f,-(e-this.height)*window.devicePixelRatio,0)},d.clamp=function(t,i,e){return Math.max(Math.min(t,e),i)},l._eventPoint=function(t){var i=t.offsetX||t.pageX-this._canvas.offsetLeft,e=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(i,e)},l._tileImage=function(t,i,e){var n=this,a=this.getTileUrl(t,i,e),o=this._tileCache[a];return o||(o=new Image,o.src=a,o.onload=function(){n.redraw()},this._tileCache[a]=o),o},l._intersectRect=function(t,i){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},i={left:i.x,right:i.x+i.width,top:i.y,bottom:i.y+i.height},!(i.left>t.right||i.right<t.left||i.top>t.bottom||i.bottom<t.top)},l._currentTool=function(){var t=this;return this.tools.find(function(i){return i.name===t._state.tool})},d._distance=function(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))},c(i,{LINE:{get:e,configurable:!0,enumerable:!0},ARROW:{get:n,configurable:!0,enumerable:!0},CIRCLE:{get:a,configurable:!0,enumerable:!0},RECTANGLE:{get:o,configurable:!0,enumerable:!0}}),d._onLine=function(t,i){var e=i.x-t.p1.x,n=i.y-t.p1.y,a=t.p2.x-t.p1.x,o=t.p2.y-t.p1.y,r=e*o-n*a;return Math.abs(r)<2e4&&i.x<Math.max(t.p1.x,t.p2.x)+_hitMargin&&i.x>Math.min(t.p1.x,t.p2.x)-_hitMargin&&i.y<Math.max(t.p1.y,t.p2.y)+_hitMargin&&i.y>Math.min(t.p1.y,t.p2.y)-_hitMargin},h(i,d),h(i.prototype,l),d=l=void 0,i}();