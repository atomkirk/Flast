var Flast=function(){"use strict";function t(e){var i=arguments[1];void 0===i&&(i={}),this.width=e.clientWidth,this.height=e.clientHeight,this.maxZoom=i.maxZoom||4,this.zoomSpeed=i.zoomSpeed||1.01,this.getTileUrl=i.getTileUrl||function(t,e,i){return"http://useredline-api.s3.amazonaws.com/development/tiles/168d136e60b14850d7a671e8/tile_"+t+("_"+e)+("x"+i)+".jpg"},this.tools=i.tools||[t.ARROW,t.LINE,t.CIRCLE,t.RECTANGLE],this.annotations=i.annotations||[],this._canvas=e,this._ctx=e.getContext("2d"),this._dragStart,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._currentAnnotation=[],this._currentShape,this._maxScale=2,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this._addEventListeners(),this._configureCanvas(),this.setTileSize(i.tileSize||{width:624,height:416}),this.redraw()}function e(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.moveTo(i.x,i.y);var r={dx:n.x-i.x,dy:n.y-i.y},o=Math.sqrt(Math.pow(r.dx,2)+Math.pow(r.dy,2)),a=(o-20)/o;t.lineTo(i.x+r.dx*a,i.y+r.dy*a),t.stroke();var s=Math.atan((n.y-i.y)/(n.x-i.x));s+=(n.x>i.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(n.x,n.y),t.rotate(s),t.moveTo(0,0),t.lineTo(15,60),t.lineTo(-15,60),t.closePath(),t.restore(),t.fill()}}}function i(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(n.x,n.y),t.stroke()}}}function n(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:t,radius:0}},updateGeometry:function(t,e){var i=t.center;return t.radius=Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2)),t},drawInContext:function(t,e){var i=e;t.beginPath(),t.arc(i.center.x,i.center.y,i.radius,0,2*Math.PI),t.stroke()}}}function r(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{p1:t,p2:t}},updateGeometry:function(t,e){return t.p2=e,t},drawInContext:function(t,e){var i=e.p1,n=e.p2;t.beginPath(),t.strokeRect(i.x,i.y,n.x-i.x,n.y-i.y),t.stroke()}}}var o=(function(t,e){return t.__proto__={a:e},t.a===e}({},{}),Object.defineProperty),a=Object.getOwnPropertyDescriptor,s=function(t,e){for(var i in e)e.hasOwnProperty(i)&&o(t,i,a(e,i));return t},h=Object.defineProperties,c={},u={};return o(t,"prototype",{configurable:!1,enumerable:!1,writable:!1}),u.setTool=function(t){var e=this.tools.find(function(e){return e.name===t});e?this._state.tool=t:console.error("Flask: That tool is not defined.")},u.setTileSize=function(t){this.tileSize=t,this._tileCache={},this._contentSize={width:this.tileSize.width*Math.pow(2,this.maxZoom),height:this.tileSize.height*Math.pow(2,this.maxZoom)};var e=this.width/this._contentSize.width,i=this.height/this._contentSize.height;this._minScale=Math.max(e,i)},u.redraw=function(){var t=this,e=this._transformedPoint(0,0),i=this._transformedPoint(this.width,this.height),n={x:e.x,y:e.y,width:i.x-e.x,height:i.y-e.y};this._ctx.clearRect(n.x,n.y,n.width,n.height);for(var r=Math.log(this._minScale)/Math.LN2,o=Math.log(this._maxScale)/Math.LN2,a=Math.log(this._transform.a)/Math.LN2,s=(a-r)/(o-r),h=Math.max(Math.ceil(s*this.maxZoom),1),c=Math.pow(2,h),u=this._contentSize.width/c,d=this._contentSize.height/c,_=0;_<c;_++)for(var l=0;l<c;l++){var f={x:Math.floor(_*u),y:Math.floor(l*d),width:Math.floor(u),height:Math.floor(d)};if(this._intersectRect(n,f)){var m=this._tileImage(h,_,l);m.complete&&0!==m.naturalHeight&&this._ctx.drawImage(m,f.x,f.y,f.width,f.height)}}this._ctx.fillStyle="#FF0000",this._ctx.strokeStyle="#FF0000",this._ctx.lineWidth=10,this.annotations.concat(this._currentAnnotation).forEach(function(e){var i=e.shapes;e===t._currentAnnotation&&(i=i.concat(t._currentShape||[])),i.forEach(function(e){var i=t.tools.find(function(t){return t.name===e.kind});i.drawInContext(t._ctx,e.geometry)})})},u._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},u._configureCanvas=function(){this._canvas.setAttribute("width",this.width),this._canvas.setAttribute("height",this.height)},u._updateZoom=function(e){var i=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;if(i){var n=this._eventPoint(e);this._currentShape&&(this._currentShape.geometry.p2=n);var r=Math.pow(this.zoomSpeed,i),o=t.clamp(this._transform.a*r,this._minScale,this._maxScale);this._transform=this._transform.translate(n.x,n.y),this._transform.a=this._transform.d=o,this._transform=this._transform.translate(-n.x,-n.y),this._clampToBounds(),this._updateTransform()}return e.preventDefault()&&!1},u._mouseDown=function(t){this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},u._mouseUp=function(t){if(this._state.mouse="up",this._state.dragging)this._state.dragging=!1;else if(this._state.drawing||"none"===this._state.tool)this._state.drawing&&(this._state.drawing=!1,this._currentAnnotation.push(this._currentShape),this._currentShape=null);else{this._state.drawing=!0;var e=this._eventPoint(t),i=this._currentTool();this._currentShape={kind:i.name,geometry:i.startGeometry(e)}}},u._mouseMove=function(t){var e=this._eventPoint(t);if("down"!==this._state.mouse||this._state.dragging||(this._state.dragging=!0),this._state.dragging){var i=e.x-this._dragStart.x,n=e.y-this._dragStart.y;this._transform=this._transform.translate(i,n),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var r=this._currentTool();this._currentShape.geometry=r.updateGeometry(this._currentShape.geometry,e),this.redraw()}},u._keyUp=function(t){function e(t){if(t){if(Array.isArray(t))return 0;var e;if(s&&s(t),"object"==typeof t&&"function"==typeof(e=t[a]))return s&&s(void 0),e.call(t);if(s&&s(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}var i,n,r,o,a="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",s="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;if(this._state.drawing&&27===t.which)this._state.drawing=!1,this._currentShape=null,this.redraw();else{o=this.tools,i=e(o),r=0===i,n=r?o.length:void 0;for(var h;r?i<n:!(n=i.next()).done;)h=r?o[i++]:n.value,t.which===h.keyCode&&(this._state.tool=h.name);i=n=r=o=void 0}},u._transformedPoint=function(t,e){var i=this._svg.createSVGPoint();return i.x=t,i.y=e,i.matrixTransform(this._transform.inverse())},u._updateTransform=function(){var t=this._transform;this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f),this.redraw()},u._clampToBounds=function(){var e=this._contentSize.width*this._transform.a,i=this._contentSize.height*this._transform.d;this._transform.e=t.clamp(this._transform.e,-(e-this.width),0),this._transform.f=t.clamp(this._transform.f,-(i-this.height),0)},c.clamp=function(t,e,i){return Math.max(Math.min(t,i),e)},u._eventPoint=function(t){var e=t.offsetX||t.pageX-this._canvas.offsetLeft,i=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(e,i)},u._tileImage=function(t,e,i){var n=this,r=this.getTileUrl(t,e,i),o=this._tileCache[r];return o||(o=new Image,o.src=r,o.onload=function(){n.redraw()},this._tileCache[r]=o),o},u._intersectRect=function(t,e){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},e={left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},u._currentTool=function(){var t=this;return this.tools.find(function(e){return e.name===t._state.tool})},h(t,{ARROW:{get:e,configurable:!0,enumerable:!0},LINE:{get:i,configurable:!0,enumerable:!0},CIRCLE:{get:n,configurable:!0,enumerable:!0},RECTANGLE:{get:r,configurable:!0,enumerable:!0}}),s(t,c),s(t.prototype,u),c=u=void 0,t}();