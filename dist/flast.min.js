var Flast=function(){"use strict";function t(t){if(t){if(Array.isArray(t))return 0;var e;if(_&&_(t),"object"==typeof t&&"function"==typeof(e=t[d]))return _&&_(void 0),e.call(t);if(_&&_(void 0),t+""=="[object Generator]")return t}throw new Error(t+" is not iterable")}function e(t){var n=arguments[1];void 0===n&&(n={}),this.width=t.clientWidth,this.height=t.clientHeight,this.maxZoom=n.maxZoom||4,this.zoomSpeed=n.zoomSpeed||1.01,this.getTileUrl=n.getTileUrl||function(t,e,n){return"http://useredline-api.s3.amazonaws.com/development/tiles/168d136e60b14850d7a671e8/tile_"+t+("_"+e)+("x"+n)+".jpg"},this.tools=n.tools||[e.ARROW,e.LINE,e.CIRCLE,e.RECTANGLE],this.annotations=n.annotations||[],this.callbacks=n.callbacks||{},this._canvas=t,this._ctx=t.getContext("2d"),this._dragStart,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._transform=this._svg.createSVGMatrix(),this._currentAnnotation=null,this._currentShape=null,this._maxScale=2,this._state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this._addEventListeners(),this._configureCanvas(),this.setTileSize(n.tileSize||{width:624,height:416}),this.redraw()}function n(){return{name:"arrow",keyCode:65,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,e){return t.p2={x:e.x,y:e.y},t},boundingRect:function(t){var e=Math.min(t.p1.x,t.p2.x),n=Math.max(t.p1.x,t.p2.x),i=Math.min(t.p1.y,t.p2.y),a=Math.max(t.p1.y,t.p2.y);return{x:e,y:i,width:n-e,height:a-i}},drawInContext:function(t,e){var n=e.p1,i=e.p2,a=60;t.beginPath(),t.moveTo(n.x,n.y);var r={dx:i.x-n.x,dy:i.y-n.y},o=Math.sqrt(Math.pow(r.dx,2)+Math.pow(r.dy,2)),s=(o-a)/o;t.lineTo(n.x+r.dx*s,n.y+r.dy*s),t.stroke();var h=Math.atan((i.y-n.y)/(i.x-n.x));h+=(i.x>n.x?90:-90)*Math.PI/180,t.save(),t.beginPath(),t.translate(i.x,i.y),t.rotate(h),t.moveTo(0,0),t.lineTo(15,a),t.lineTo(-15,a),t.closePath(),t.restore(),t.fill()},hitTest:function(t,n){return e._onLine(t,n)}}}function i(){return{name:"line",keyCode:76,startGeometry:function(t){return{p1:{x:t.x,y:t.y},p2:{x:t.x,y:t.y}}},updateGeometry:function(t,e){return t.p2={x:e.x,y:e.y},t},boundingRect:function(t){var e=Math.min(t.p1.x,t.p2.x),n=Math.max(t.p1.x,t.p2.x),i=Math.min(t.p1.y,t.p2.y),a=Math.max(t.p1.y,t.p2.y);return{x:e,y:i,width:n-e,height:a-i}},drawInContext:function(t,e){var n=e.p1,i=e.p2;t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(i.x,i.y),t.stroke()},hitTest:function(t,n){return e._onLine(t,n)}}}function a(){return{name:"circle",keyCode:67,startGeometry:function(t){return{center:{x:t.x,y:t.y},radius:0}},updateGeometry:function(t,e){var n=t.center;return t.radius=Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2)),t},boundingRect:function(t){var e=t.center.x-t.radius,n=t.center.x+t.radius,i=t.center.y-t.radius,a=t.center.y+t.radius;return{x:e,y:i,width:n-e,height:a-i}},drawInContext:function(t,e){var n=e;t.beginPath(),t.arc(n.center.x,n.center.y,n.radius,0,2*Math.PI),t.stroke()},hitTest:function(t,e){var n=Math.sqrt(Math.pow(e.x-t.center.x,2)+Math.pow(e.y-t.center.y,2));return Math.abs(n-t.radius)<10}}}function r(){return{name:"rectangle",keyCode:82,startGeometry:function(t){return{x:t.x,y:t.y,width:0,height:0}},updateGeometry:function(t,e){return t.width=e.x-t.x,t.height=e.y-t.y,t},finalGeometry:function(t){return{x:Math.min(t.x,t.x+t.width),y:Math.min(t.y,t.y+t.height),width:Math.abs(t.width),height:Math.abs(t.height)}},boundingRect:function(t){return t},drawInContext:function(t,e){var n=e;t.beginPath(),t.strokeRect(n.x,n.y,n.width,n.height),t.stroke()},hitTest:function(e,n){var i,a,r,o=[Math.abs(e.x-n.x),Math.abs(e.x+e.width-n.x),Math.abs(e.y-n.y),Math.abs(e.y+e.height-n.y)];i=t(o),r=0===i,a=r?o.length:void 0;for(var s;r?i<a:!(a=i.next()).done;)if(s=r?o[i++]:a.value,s<10)return!0;i=a=r=void 0}}}var o=(function(t,e){return t.__proto__={a:e},t.a===e}({},{}),Object.defineProperty),s=Object.getOwnPropertyDescriptor,h=function(t,e){for(var n in e)e.hasOwnProperty(n)&&o(t,n,s(e,n));return t},c=Object.defineProperties,u={},l={},d="undefined"!=typeof Symbol&&Symbol&&Symbol.iterator||"@@iterator",_="undefined"!=typeof Symbol&&Symbol&&Symbol.__setObjectSetter__;return o(e,"prototype",{configurable:!1,enumerable:!1,writable:!1}),l.setTool=function(t){var e=this.tools.find(function(e){return e.name===t});e?(this._state.tool=t,this.redraw()):console.error("Flask: That tool is not defined.")},l.setTileSize=function(t){this.tileSize=t,this._tileCache={},this._contentSize={width:this.tileSize.width*Math.pow(2,this.maxZoom),height:this.tileSize.height*Math.pow(2,this.maxZoom)};var e=this.width/this._contentSize.width,n=this.height/this._contentSize.height;this._minScale=Math.max(e,n)},l.redraw=function(){var e,n,i,a,r,o,s,h=this,c=this._transformedPoint(0,0),u=this._transformedPoint(this.width,this.height),l={x:c.x,y:c.y,width:u.x-c.x,height:u.y-c.y};this._ctx.clearRect(l.x,l.y,l.width,l.height);for(var d=Math.log(this._minScale)/Math.LN2,_=Math.log(this._maxScale)/Math.LN2,f=Math.log(this._transform.a)/Math.LN2,m=(f-d)/(_-d),p=Math.max(Math.ceil(m*this.maxZoom),1),g=Math.pow(2,p),y=this._contentSize.width/g,x=this._contentSize.height/g,v=0;v<g;v++)for(var w=0;w<g;w++){var b={x:Math.floor(v*y),y:Math.floor(w*x),width:Math.floor(y),height:Math.floor(x)};if(this._intersectRect(l,b)){var M=this._tileImage(p,v,w);if(M.complete&&0!==M.naturalHeight)this._ctx.drawImage(M,b.x,b.y,b.width,b.height);else for(var S=p-1;S>0;){var k=Math.floor(v/Math.pow(2,p)*Math.pow(2,S)),T=Math.floor(w/Math.pow(2,p)*Math.pow(2,S)),A=this._tileImage(S,k,T);if(A.complete&&0!==A.naturalHeight){var C=Math.pow(2,p)/Math.pow(2,S),L=v-C*k,P=w-C*T,E=A.width/C,G=A.height/C,z=Math.floor(L*E),I=Math.floor(P*G);this._ctx.drawImage(A,z,I,E,G,b.x,b.y,b.width,b.height);break}S-=1}}}var R=this._currentAnnotation||{shapes:[]};a=this.annotations.concat(R),e=t(a),i=0===e,n=i?a.length:void 0;for(var D;i?e<n:!(n=e.next()).done;){D=i?a[e++]:n.value,this._currentAnnotation&&D!==this._currentAnnotation?this._ctx.globalAlpha=.2:this._ctx.globalAlpha=1;var U=D.shapes;D===R&&(U=U.concat(this._currentShape||[])),r=t(U),s=0===r,o=s?U.length:void 0;for(var O;s?r<o:!(o=r.next()).done;)O=s?U[r++]:o.value,function(t){var e=h.tools.find(function(e){return e.name===t.kind});h._ctx.fillStyle="#FF0000",h._ctx.strokeStyle="#FF0000",h._ctx.lineWidth=10,e.drawInContext(h._ctx,t.geometry)}(O);r=o=s=void 0}e=n=i=a=void 0,this._ctx.globalAlpha=1},l.completeAnnotation=function(){this._currentAnnotation&&(this.annotations.indexOf(this._currentAnnotation)<0&&this.annotations.push(this._currentAnnotation),this.callbacks.annotationCompleted&&this.callbacks.annotationCompleted(this._currentAnnotation)),this._currentAnnotation=null,this._state.tool="none",this.redraw()},l._addEventListeners=function(){this._canvas.addEventListener("mousedown",this._mouseDown.bind(this),!1),this._canvas.addEventListener("mousemove",this._mouseMove.bind(this),!1),this._canvas.addEventListener("mouseleave",this._mouseLeave.bind(this),!1),this._canvas.addEventListener("mouseup",this._mouseUp.bind(this),!1),this._canvas.addEventListener("DOMMouseScroll",this._updateZoom.bind(this),!1),this._canvas.addEventListener("mousewheel",this._updateZoom.bind(this),!1),window.addEventListener("keyup",this._keyUp.bind(this),!1)},l._configureCanvas=function(){this._canvas.setAttribute("width",this.width),this._canvas.setAttribute("height",this.height)},l._updateZoom=function(t){var n=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(n){var i=this._eventPoint(t);if(this._currentShape){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,i)}var r=Math.pow(this.zoomSpeed,n),o=e.clamp(this._transform.a*r,this._minScale,this._maxScale);this._transform=this._transform.translate(i.x,i.y),this._transform.a=this._transform.d=o,this._transform=this._transform.translate(-i.x,-i.y),this._clampToBounds(),this._updateTransform()}return t.preventDefault()&&!1},l._mouseDown=function(t){this._state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this._dragStart=this._eventPoint(t)},l._mouseUp=function(e){var n,i,a,r,o,s,h,c,u=this;if(this._state.mouse="up",this._state.dragging)this._state.dragging=!1;else if(this._state.drawing||"none"===this._state.tool){if(this._state.drawing){this._state.drawing=!1,this._currentAnnotation||(this._currentAnnotation={shapes:[]},this.callbacks.editingAnnotation&&this.callbacks.editingAnnotation(this._currentAnnotation));var l=this._currentTool();l.finalGeometry&&(this._currentShape.geometry=l.finalGeometry(this._currentShape.geometry)),this._currentAnnotation.shapes.push(this._currentShape),this.callbacks.finishedDrawingShape&&this.callbacks.finishedDrawingShape(this._currentShape),this._currentShape=null,this.redraw()}else if(!this._currentAnnotation){var d=this._eventPoint(e);r=this.annotations,n=t(r),a=0===n,i=a?r.length:void 0;for(var _;a?n<i:!(i=n.next()).done;){_=a?r[n++]:i.value,c=_.shapes,o=t(c),h=0===o,s=h?c.length:void 0;for(var f;h?o<s:!(s=o.next()).done;){f=h?c[o++]:s.value;var m;if(function(t){var e=u.tools.find(function(e){return e.name===t.kind});if(e.hitTest(t.geometry,d)&&u.callbacks.annotationSelected)return u.callbacks.annotationSelected(_),u._currentAnnotation=_,u.callbacks.editingAnnotation&&u.callbacks.editingAnnotation(_),u.redraw(),void(m=!0)}(f),m===!0)return void(m=void 0)}o=s=h=c=void 0}n=i=a=r=void 0}}else{this._state.drawing=!0;var p=this._eventPoint(e),g=this._currentTool();this._currentShape={kind:g.name,geometry:g.startGeometry(p)},this.callbacks.beganDrawingShape&&this.callbacks.beganDrawingShape(this._currentShape)}},l._mouseMove=function(t){var e=this._eventPoint(t);if("down"!==this._state.mouse||this._state.dragging||(this._state.dragging=!0),this._state.dragging){var n=e.x-this._dragStart.x,i=e.y-this._dragStart.y;this._transform=this._transform.translate(n,i),this._clampToBounds(),this._updateTransform()}if(this._state.drawing){var a=this._currentTool();this._currentShape.geometry=a.updateGeometry(this._currentShape.geometry,e),this.redraw()}},l._mouseLeave=function(t){this._state.dragging&&(this._state.dragging=!1,this._state.mouse="up")},l._keyUp=function(e){var n,i,a,r;if(this._state.drawing&&27===e.which)this.callbacks.cancelledDrawingShape&&this.callbacks.cancelledDrawingShape(this._currentShape),this._state.drawing=!1,this._currentShape=null,this.redraw();else{r=this.tools,n=t(r),a=0===n,i=a?r.length:void 0;for(var o;a?n<i:!(i=n.next()).done;)o=a?r[n++]:i.value,e.which===o.keyCode&&(this._state.tool=o.name);n=i=a=r=void 0}},l._transformedPoint=function(t,e){var n=this._svg.createSVGPoint();return n.x=t,n.y=e,n.matrixTransform(this._transform.inverse())},l._updateTransform=function(){var t=this._transform;this._ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f),this.redraw(),this.callbacks.transformWasUpdated&&this.callbacks.transformWasUpdated(t)},l._clampToBounds=function(){var t=this._contentSize.width*this._transform.a,n=this._contentSize.height*this._transform.d;this._transform.e=e.clamp(this._transform.e,-(t-this.width),0),this._transform.f=e.clamp(this._transform.f,-(n-this.height),0)},u.clamp=function(t,e,n){return Math.max(Math.min(t,n),e)},l._eventPoint=function(t){var e=t.offsetX||t.pageX-this._canvas.offsetLeft,n=t.offsetY||t.pageY-this._canvas.offsetTop;return this._transformedPoint(e,n)},l._tileImage=function(t,e,n){var i=this,a=this.getTileUrl(t,e,n),r=this._tileCache[a];return r||(r=new Image,r.src=a,r.onload=function(){i.redraw()},this._tileCache[a]=r),r},l._intersectRect=function(t,e){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},e={left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},l._currentTool=function(){var t=this;return this.tools.find(function(e){return e.name===t._state.tool})},c(e,{ARROW:{get:n,configurable:!0,enumerable:!0},LINE:{get:i,configurable:!0,enumerable:!0},CIRCLE:{get:a,configurable:!0,enumerable:!0},RECTANGLE:{get:r,configurable:!0,enumerable:!0}}),u._onLine=function(t,e){var n=e.x-t.p1.x,i=e.y-t.p1.y,a=t.p2.x-t.p1.x,r=t.p2.y-t.p1.y,o=n*r-i*a;return Math.abs(o)<2e4&&e.x<Math.max(t.p1.x,t.p2.x)+10&&e.x>Math.min(t.p1.x,t.p2.x)-10&&e.y<Math.max(t.p1.y,t.p2.y)+10&&e.y>Math.min(t.p1.y,t.p2.y)-10},h(e,u),h(e.prototype,l),u=l=void 0,e}();