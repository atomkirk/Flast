var Flask=function(){"use strict";function t(t){this.canvas=t,this.setup(),this.zoomSpeed=1.01,this.maxZoomLevel=4,this.width=624*Math.pow(2,this.maxZoomLevel),this.height=416*Math.pow(2,this.maxZoomLevel),this.maxScale=2,this.ctx=t.getContext("2d"),this.dragStart,this.canvas,this.ctx,this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.transform=this.svg.createSVGMatrix(),this.tileCache={};var e=this.canvas.width/this.width,i=this.canvas.height/this.height;this.minScale=Math.max(e,i),this.annotations=[],this.currentAnnotation=[],this.currentShape,this.state={mouse:"up",tool:"none",dragging:!1,drawing:!1},this.redraw()}var e=(function(t,e){return t.__proto__={a:e},t.a===e}({},{}),Object.defineProperty),i=Object.getOwnPropertyDescriptor,s=function(t,s){for(var a in s)s.hasOwnProperty(a)&&e(t,a,i(s,a));return t},a={};return e(t,"prototype",{configurable:!1,enumerable:!1,writable:!1}),a.setup=function(){this.canvas.addEventListener("mousedown",this.mouseDown.bind(this),!1),this.canvas.addEventListener("mousemove",this.mouseMove.bind(this),!1),this.canvas.addEventListener("mouseup",this.mouseUp.bind(this),!1),this.canvas.addEventListener("DOMMouseScroll",this.updateZoom.bind(this),!1),this.canvas.addEventListener("mousewheel",this.updateZoom.bind(this),!1),window.addEventListener("keyup",this.keyUp.bind(this),!1)},a.updateZoom=function(t){var e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;if(e){var i=this.eventPoint(t);this.currentShape&&(this.currentShape.geometry.p2=i);var s=Math.pow(this.zoomSpeed,e),a=this.clamp(this.transform.a*s,this.minScale,this.maxScale);this.transform=this.transform.translate(i.x,i.y),this.transform.a=this.transform.d=a,this.transform=this.transform.translate(-i.x,-i.y),this.clampToBounds(),this.updateTransform()}return t.preventDefault()&&!1},a.mouseDown=function(t){this.state.mouse="down",document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",this.dragStart=this.eventPoint(t)},a.mouseUp=function(t){if(this.state.mouse="up",this.state.dragging)this.state.dragging=!1;else if(this.state.drawing||"none"===this.state.tool)this.state.drawing&&(this.state.drawing=!1,this.currentAnnotation.push(this.currentShape),this.currentShape=null);else{this.state.drawing=!0;var e=this.eventPoint(t);"arrow"===this.state.tool||"line"===this.state.tool||"rectangle"===this.state.tool?this.currentShape={kind:this.state.tool,geometry:{p1:e,p2:e}}:"circle"===this.state.tool&&(this.currentShape={kind:"circle",geometry:{center:e,radius:0}})}},a.mouseMove=function(t){var e=this.eventPoint(t);if("down"!==this.state.mouse||this.state.dragging||(this.state.dragging=!0),this.state.dragging){var i=e.x-this.dragStart.x,s=e.y-this.dragStart.y;this.transform=this.transform.translate(i,s),this.clampToBounds(),this.updateTransform()}if(this.state.drawing)if("arrow"===this.state.tool||"line"===this.state.tool||"rectangle"===this.state.tool)this.currentShape.geometry.p2=e,this.redraw();else if("circle"===this.state.tool){var a=this.currentShape.geometry.center;this.currentShape.geometry.radius=Math.sqrt(Math.pow(e.x-a.x,2)+Math.pow(e.y-a.y,2)),this.redraw()}},a.keyUp=function(t){this.state.drawing&&27===t.which?(this.state.drawing=!1,this.currentShape=null,this.redraw()):65===t.which?this.state.tool="arrow":76===t.which?this.state.tool="line":67===t.which?this.state.tool="circle":82===t.which&&(this.state.tool="rectangle")},a.transformedPoint=function(t,e){var i=this.svg.createSVGPoint();return i.x=t,i.y=e,i.matrixTransform(this.transform.inverse())},a.updateTransform=function(){var t=this.transform;this.ctx.setTransform(t.a,t.b,t.c,t.d,t.e,t.f),this.redraw()},a.redraw=function(){var t=this,e=this.transformedPoint(0,0),i=this.transformedPoint(this.canvas.width,this.canvas.height),s={x:e.x,y:e.y,width:i.x-e.x,height:i.y-e.y};this.ctx.clearRect(s.x,s.y,s.width,s.height);for(var a=Math.log(this.minScale)/Math.LN2,r=Math.log(this.maxScale)/Math.LN2,h=Math.log(this.transform.a)/Math.LN2,o=(h-a)/(r-a),n=Math.max(Math.ceil(o*this.maxZoomLevel),1),c=Math.pow(2,n),l=this.width/c,d=this.height/c,m=0;m<c;m++)for(var u=0;u<c;u++){var f={x:Math.floor(m*l),y:Math.floor(u*d),width:Math.floor(l),height:Math.floor(d)};if(this.intersectRect(s,f)){var g=this.tileImage(n,m,u);g.complete&&0!==g.naturalHeight&&this.ctx.drawImage(g,f.x,f.y,f.width,f.height)}}this.ctx.fillStyle="#FF0000",this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=10,this.currentAnnotation.concat(this.currentShape||[]).forEach(function(e){if("arrow"===e.kind){var i=e.geometry.p1,s=e.geometry.p2;t.ctx.beginPath(),t.ctx.moveTo(i.x,i.y);var a={dx:s.x-i.x,dy:s.y-i.y},r=Math.sqrt(Math.pow(a.dx,2)+Math.pow(a.dy,2)),h=(r-20)/r;t.ctx.lineTo(i.x+a.dx*h,i.y+a.dy*h),t.ctx.stroke();var o=Math.atan((s.y-i.y)/(s.x-i.x));o+=(s.x>i.x?90:-90)*Math.PI/180,t.ctx.save(),t.ctx.beginPath(),t.ctx.translate(s.x,s.y),t.ctx.rotate(o),t.ctx.moveTo(0,0),t.ctx.lineTo(15,60),t.ctx.lineTo(-15,60),t.ctx.closePath(),t.ctx.restore(),t.ctx.fill()}else if("line"===e.kind){var n=e.geometry.p1,c=e.geometry.p2;t.ctx.beginPath(),t.ctx.moveTo(n.x,n.y),t.ctx.lineTo(c.x,c.y),t.ctx.stroke()}else if("circle"===e.kind){t.ctx.beginPath();var l=e.geometry;t.ctx.arc(l.center.x,l.center.y,l.radius,0,2*Math.PI),t.ctx.stroke()}else if("rectangle"===e.kind){t.ctx.beginPath();var d=e.geometry.p1,m=e.geometry.p2;t.ctx.strokeRect(d.x,d.y,m.x-d.x,m.y-d.y),t.ctx.stroke()}})},a.clampToBounds=function(){var t=this.width*this.transform.a,e=this.height*this.transform.d;this.transform.e=this.clamp(this.transform.e,-(t-this.canvas.width),0),this.transform.f=this.clamp(this.transform.f,-(e-this.canvas.height),0)},a.clamp=function(t,e,i){return Math.max(Math.min(t,i),e)},a.eventPoint=function(t){var e=t.offsetX||t.pageX-this.canvas.offsetLeft,i=t.offsetY||t.pageY-this.canvas.offsetTop;return this.transformedPoint(e,i)},a.tileImage=function(t,e,i){var s=this,a="http://useredline-api.s3.amazonaws.com/development/tiles/168d136e60b14850d7a671e8/tile_"+t+("_"+e)+("x"+i)+".jpg",r=this.tileCache[a];return r||(r=new Image,r.src=a,r.onload=function(){s.redraw()},this.tileCache[a]=r),r},a.intersectRect=function(t,e){return t={left:t.x,right:t.x+t.width,top:t.y,bottom:t.y+t.height},e={left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},s(t.prototype,a),a=void 0,t}();